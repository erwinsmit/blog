{"componentChunkName":"component---src-templates-blog-post-js","path":"/sitecore-nextjs-without-vercel/","webpackCompilationHash":"e8be326e3d102d9dd1d3","result":{"data":{"site":{"siteMetadata":{"title":"Erwin Smit blog","author":"Erwin Smit"}},"markdownRemark":{"id":"fb91f6b0-3025-5d4a-809f-fcc379265cbb","html":"<p>As we all know by now, Vercel is a great platform to host your Next.js apps. I currently use it for some small projects and I love the developer experience.\nIt’s so easy to handle deployments, preview pull requests (you get a unique URL for each pull request), real performance monitoring (using <a href=\"https://web.dev/vitals/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Core Web Vitals</a>), and much more. </p>\n<p>But… There are some drawbacks to Vercel.</p>\n<ul>\n<li>\n<p>Most clients my from my employer <a href=\"https://www.macaw.nl\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Macaw</a> already pay for a hosting provider, in the Microsoft world, this is Azure. It’s hard to also sell Vercel in that case.</p>\n</li>\n<li>\n<p>The pricing is hard to predict, it goes from <strong>free</strong> to <strong>10 dollars a month</strong> to <strong>enterprise</strong>. In Azure for example this is more transparent, with the <a href=\"https://azure.microsoft.com/en-us/pricing/calculator/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cost calculator</a> you can get a decent estimate.</p>\n</li>\n</ul>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c13974f2993f730f8cc6e16e30a302fb/782d1/vercel-pricing.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 51.0482180293501%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABp0lEQVQoz01RTY/TMBDdf8u1QssB9dATB27cyokfAAdUgVrtCm3VAwhUJATqItGKrJpsaaKkThzH8dc44aXpFkaj2M68N8/Pc9E+RHOMfkNd+rdR+mrFuCLyHnlGeu+BwfcChzAMgyD4V2ubLGdJkqyy6utOWmrAFLW6C4LNZsMY62HOuY4cx3GapkopKSX6gZxzvt1uBTuQlkepBuT7KNrv90VRAAnUiYzlfBMcLZElZ7RyuO/RCJSlMo4caNbaHtyRsYNsVVVaa9QA9g1l0ueSrFHamE658aXQklmUzu5OZFybc+4fngQIVlNyEKIsYAQtoVlynUWVkKUQAuInZSJar9d5nvdmyOGZ3a6gu1igo1SWfAtXojRpWKZZliYZz7k1riOjBzq1/wWs1hazcTDb/4HnqjaYXjeKtjlme1Iej8fD4XA0Gg0Gg8vLJ/td+CVqn763w6l9PDGPXpvJylqpb17G1y920+fRu2fhzfhPLUzneblczufzxWIxm82urq45z38f3PRWzX7qyQ/95pv+fm90rTaf818fD7fzbPUhXX9iqjZ/ATofLgaKTH1dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Vercel pricing\"\n        title=\"\"\n        src=\"/static/c13974f2993f730f8cc6e16e30a302fb/05649/vercel-pricing.png\"\n        srcset=\"/static/c13974f2993f730f8cc6e16e30a302fb/e9d1c/vercel-pricing.png 225w,\n/static/c13974f2993f730f8cc6e16e30a302fb/80b02/vercel-pricing.png 450w,\n/static/c13974f2993f730f8cc6e16e30a302fb/05649/vercel-pricing.png 900w,\n/static/c13974f2993f730f8cc6e16e30a302fb/782d1/vercel-pricing.png 954w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<ul>\n<li><strong>GDPR</strong> is especially a hard requirement for German clients. The GDPR is more strict in Germany than in other countries, although Vercel claims to cover GDPR in the EU, it does not seem to make the same amount of effort as Azure with a dedicated <a href=\"https://azure.microsoft.com/en-us/support/legal/privacy-statement/germany/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">German cloud</a>. Disclaimer: Legal stuff is not my strong suit</li>\n</ul>\n<p>I understand that some of these issues are not a problem when you use <a href=\"https://www.sitecore.com/products/xm-cloud\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sitecore XM Cloud</a>. Sitecore won’t be hosted on Azure and Vercel comes as a package with the deal (as I understand). However, that’s still in the future and some clients might not want to use XM Cloud because they prefer to host Sitecore themselves. </p>\n<p>So, it’s worth discovering options on how to do all this without the dependency on Vercel.\nWe did just that last year.</p>\n<h2 id=\"old-solution\"><a href=\"#old-solution\" aria-label=\"old solution permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Old solution,</h2>\n<p>Last year I’ve worked on a way of hosting Sitecore Next.js with Azure:</p>\n<ul>\n<li><a href=\"/nextjs-on-azure-functions/\">Next.js on Azure Functions</a></li>\n<li><a href=\"/deploy-azure-functions-github-actions/\">Deploy Azure Functions with Github Actions</a></li>\n<li><a href=\"/sitecore-jss-on-azure-functions/\">Sitecore JSS on Azure functions</a></li>\n</ul>\n<p>This diagram explains how it all works together:</p>\n<p><img src=\"/old-solution-f1d6920743754717c4431190824b30d4.svg\" alt=\"Old solution\"></p>\n<p>When I worked on this, Azure Functions version 3 was the latest version. Now it’s version 4 and proxies are not <a href=\"https://learn.microsoft.com/en-us/azure/azure-functions/functions-proxies#legacy-functions-proxies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">supported anymore</a>.\nThis December, support for Azure Functions version 3 will be switched off so this solution is not viable anymore. </p>\n<h2 id=\"a-new-proxy\"><a href=\"#a-new-proxy\" aria-label=\"a new proxy permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A new proxy</h2>\n<p>So we got back to the drawing board and came up with the following solution:</p>\n<p><img src=\"/new-solution-66a0acda081cf8540c3be50929a4d1c8.svg\" alt=\"New solution\"></p>\n<p>Instead of using Azure Function proxies a .NET application with <a href=\"https://microsoft.github.io/reverse-proxy/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">YARP (Yet another reverse proxy)</a> is used. What I like about YARP is that you almost need no code at all to get it running.\nAlmost all the proxy rules are configured through the appsettings alone, see: <a href=\"https://github.com/macaw-cad/nextjs-on-azure/blob/main/YarpProxy/appsettings.Development.json\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/macaw-cad/nextjs-on-azure/blob/main/YarpProxy/appsettings.Development.json</a>.</p>\n<p>Only for the static files from Next.js a couple of lines of code are necessary to mount the file share.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> nextMount <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span>Configuration<span class=\"token punctuation\">.</span>GetValue<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"NextMount\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseStaticFiles</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StaticFileOptions</span> <span class=\"token punctuation\">{</span> \n    FileProvider <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PhysicalFileProvider</span><span class=\"token punctuation\">(</span>nextMount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>    \n    RequestPath <span class=\"token operator\">=</span> <span class=\"token string\">\"/_next\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>That was pretty much it, we were able to re-use the code from the old solution and simply replaced the Azure functions proxy with a different one. </p>\n<p>Just after I wrote this blog post, Azure announced that Azure Static Web Apps will support Next.js with ISR/SSR &#x26; API routes soon. See the announcement about <a href=\"https://techcommunity.microsoft.com/t5/apps-on-azure-blog/extending-next-js-support-in-azure-static-web-apps/ba-p/3627975\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Next.js support here</a>.</p>\n<p>Will be interesting to see if the Sitecore JSS Next.js SDK will also work with this, perhaps coming up in a blog post soon!</p>","timeToRead":3,"frontmatter":{"title":"Sitecore JSS Next.js without Vercel","date":"October 10, 2022","spoiler":"Yes, you can still run Sitecore JSS Next.js on Azure Functions without Vercel. This can be done with custom Azure Functions and a Azure storage account with a YARP proxy in front of it."},"fields":{"slug":"/sitecore-nextjs-without-vercel/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/sitecore-nextjs-without-vercel/","previous":{"fields":{"slug":"/auto-format-typescript-npm-task/","langKey":"en","directoryName":"auto-format-typescript-npm-task"},"frontmatter":{"title":"Auto-format typescript with a npm task"}},"next":{"fields":{"slug":"/sitecore-jss-nextjs-on-azure-static-web-app/","langKey":"en","directoryName":"sitecore-jss-nextjs-on-azure-static-web-app"},"frontmatter":{"title":"Sitecore JSS Next.js on Azure Static Web Apps"}},"translations":[],"translatedLinks":[]}}}