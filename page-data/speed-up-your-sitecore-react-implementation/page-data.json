{"componentChunkName":"component---src-templates-blog-post-js","path":"/speed-up-your-sitecore-react-implementation/","webpackCompilationHash":"d76f921222e0095d1a0e","result":{"data":{"site":{"siteMetadata":{"title":"Erwin Smit blog","author":"Erwin Smit"}},"markdownRemark":{"id":"98c55258-cc39-5bab-82c2-94958bb94b5c","html":"<p>On a lot of Sitecore sites that jumped on the React bandwagon a while ago I notice some performance issues. In this post I will explain how to fix this and make your Sitecore/React implementation almost as fast as a site build with <a href=\"https://www.erwinsmit.com/make-your-sxa-site-perform/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Stencil components</a></p>\n<p>The two main issues with these websites are <strong>Render blocking script tags</strong> and <strong>unused javascript</strong>. Let’s fix it!</p>\n<h2 id=\"render-blocking-script-tags\"><a href=\"#render-blocking-script-tags\" aria-label=\"render blocking script tags permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Render blocking script tags</h2>\n<p>I created a static <a href=\"https://www.erwinsmit.com/performancepoc\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">html page</a> that reflects how many Sitecore sites work, it has inline script tags that refer to React components. Although these components are already rendered server side they still need to be “Hydrated”. Hydration of a React component adds all the client side magic like event listeners, state changes, hooks etc. </p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39af2d2ed855611f4444383da874bc52/a172d/hydration.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 15.049299429164503%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAGyAD//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAR/9oACAEBAAE/IcjP/9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABYQAQEBAAAAAAAAAAAAAAAAAAERAP/aAAgBAQABPxCMkuBd/9k='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"hydration\"\n        title=\"Hydrate React component\"\n        src=\"/static/39af2d2ed855611f4444383da874bc52/2d017/hydration.jpg\"\n        srcset=\"/static/39af2d2ed855611f4444383da874bc52/40f63/hydration.jpg 225w,\n/static/39af2d2ed855611f4444383da874bc52/df2c7/hydration.jpg 450w,\n/static/39af2d2ed855611f4444383da874bc52/2d017/hydration.jpg 900w,\n/static/39af2d2ed855611f4444383da874bc52/bbff7/hydration.jpg 1350w,\n/static/39af2d2ed855611f4444383da874bc52/98235/hydration.jpg 1800w,\n/static/39af2d2ed855611f4444383da874bc52/a172d/hydration.jpg 1927w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<p>It’s no exception to have about 20 of these inline script tags on the page to hydrate all the necessary React components. There are two issues with this approach. Every script tag that is not at the absolute bottom of the page <strong>blocks the rendering</strong> of the HTML that follows, so the footer will not be rendered <strong>until</strong> the script tags in the main section are executed. The same applies for the rendering of the main section, this will not happen until the hydration of the header navigation is completed. For performance reasons this is not ideal, the HTML of the components is already server side rendered meaning that the user can see and interact with most of the HTML. </p>\n<p>The <strong>second issue</strong> with this approach is the the dependency on global modules within the script tags, “ClientX.default.Navigation” needs to be registered on the Window object otherwise runtime exceptions will occur. Therefor the JavaScript bundle responsible for registering these components is at the top of the page. As a result the browser first needs to load and execute this script before it can render the HTML. You can imagine tools like Google Lighthouse are not happy with this!</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ae521b97aeabf182d48ab3a14e104cbc/6b270/lighthouse-not-happy.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.13909994155465%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3aEB/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAEQEQ/9oACAEBAAE/ISO//9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAICAwAAAAAAAAAAAAAAAAABESExUYH/2gAIAQEAAT8QtXyBpNZJjTP/2Q=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"lighthouse not happy\"\n        title=\"Lighthouse isn't happy!\"\n        src=\"/static/ae521b97aeabf182d48ab3a14e104cbc/2d017/lighthouse-not-happy.jpg\"\n        srcset=\"/static/ae521b97aeabf182d48ab3a14e104cbc/40f63/lighthouse-not-happy.jpg 225w,\n/static/ae521b97aeabf182d48ab3a14e104cbc/df2c7/lighthouse-not-happy.jpg 450w,\n/static/ae521b97aeabf182d48ab3a14e104cbc/2d017/lighthouse-not-happy.jpg 900w,\n/static/ae521b97aeabf182d48ab3a14e104cbc/bbff7/lighthouse-not-happy.jpg 1350w,\n/static/ae521b97aeabf182d48ab3a14e104cbc/6b270/lighthouse-not-happy.jpg 1711w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a> </p>\n<h3 id=\"how-to-fix-this\"><a href=\"#how-to-fix-this\" aria-label=\"how to fix this permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to fix this?</h3>\n<p>In the entrypoint for the client bundle the code usually looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=React!react\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=ReactDOM!react-dom\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=ClientX!../src/components\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>React &#x26; ReactDOM are exposed to the window object and src/components refers to a entrypoint for all the components used within the sitecore rendering. That entrypoint is usually build up with a lot of imports and exports:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> SearchResults <span class=\"token keyword\">from</span> <span class=\"token string\">'./30_Organisms/Blog/BlogPostsOverview'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> SearchBox <span class=\"token keyword\">from</span> <span class=\"token string\">'./30_Organisms/SearchBox/container'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> BlogPostDetails <span class=\"token keyword\">from</span> <span class=\"token string\">'./30_Organisms/Blog/BlogPostDetails'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Contact <span class=\"token keyword\">from</span> <span class=\"token string\">'./20_Molecules/Contact'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> NavigationSearchBox <span class=\"token keyword\">from</span> <span class=\"token string\">'./30_Organisms/SearchBox/variants/SimpleSearchBox'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> BannerTeaser <span class=\"token keyword\">from</span> <span class=\"token string\">'./20_Molecules/Teasers/BannerTeaser'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n    BlockTeaser<span class=\"token punctuation\">,</span> \n    Button<span class=\"token punctuation\">,</span> \n    <span class=\"token constant\">FAQ</span><span class=\"token punctuation\">,</span>  \n    FAQList<span class=\"token punctuation\">,</span>\n    NavigationImageList<span class=\"token punctuation\">,</span> \n    FooterMainImage\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This causes the components to be registered on the window object like “window.ClientX.default.FAQ”</p>\n<p>To fix the render blocking we first put HTML comments <!-- --> around all the hydration script. I also added a react-data-hydrate attribute so they are easily distinguishable from other inline scripts (e.g. Google tag manager).</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!--\n    &lt;script data-react-hydrate>\n        ReactDOM.hydrate(React.createElement(ClientX.default.Navigation, \n        { \"module\": \"ClientX.default.Navigation\", \"id\": \"a2feda75-fd69-4811-962a-dd5411e3e7dd\", \"name\": \"Main Navigation\", \"variant\": \"vertical\", \"editing\": false, \"datasource\": { \"id\": \"518f590a-a4cc-446a-be85-b44efc8e4f6c\" } } ))\n    &lt;/script>    \n--></span>     </code></pre></div>\n<p>Now let’s change the entrypoint to the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=React!react\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=ReactDOM!react-dom\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=ClientX!../src/components\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bodyHtml <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">;</span>\nbodyHtml<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/(?=&lt;!--&lt;script data-react-hydrate)([\\s\\S]*?)-->/gm</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">match</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> scriptTag <span class=\"token operator\">=</span> match<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/^&lt;!--|-->$|&lt;script data-react-hydrate>|&lt;\\/script>/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Function</span><span class=\"token punctuation\">(</span>scriptTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hydrating error:'</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>With a regex we collect all the hydration scripts, and execute them by creating a function from the string and execute it directly. Now we can also move the reference to the client bundle to the bottom of the page as done <a href=\"https://www.erwinsmit.com/performancepoc/without-render-blockers.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>. </p>\n<p>As a result, the Google Lighthouse warning is almost gone!</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/94a26922e5810e82ee617c6766c65900/a4d78/lighthouse-no-render-blockers.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 38.554948391013966%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3aEB/8QAFRABAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQEAAQUCj//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABYQAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAQABPyERn//aAAwDAQACAAMAAAAQcA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAACAwEBAAAAAAAAAAAAAAAAEQExkUGB/9oACAEBAAE/EIbcYLFLBrj9P//Z'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"lighthouse no render blockers\"\n        title=\"Lighthouse almost happy\"\n        src=\"/static/94a26922e5810e82ee617c6766c65900/2d017/lighthouse-no-render-blockers.jpg\"\n        srcset=\"/static/94a26922e5810e82ee617c6766c65900/40f63/lighthouse-no-render-blockers.jpg 225w,\n/static/94a26922e5810e82ee617c6766c65900/df2c7/lighthouse-no-render-blockers.jpg 450w,\n/static/94a26922e5810e82ee617c6766c65900/2d017/lighthouse-no-render-blockers.jpg 900w,\n/static/94a26922e5810e82ee617c6766c65900/bbff7/lighthouse-no-render-blockers.jpg 1350w,\n/static/94a26922e5810e82ee617c6766c65900/a4d78/lighthouse-no-render-blockers.jpg 1647w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<p>It’s still complaining about the css bundle blocking things, to fix that usually applying CSSPurge as discussed in a <a href=\"https://www.erwinsmit.com/make-your-sxa-site-perform/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">previous blog post</a> is enough.</p>\n<h2 id=\"unused-javascript\"><a href=\"#unused-javascript\" aria-label=\"unused javascript permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unused JavaScript</h2>\n<p>As discussed above, the entrypoint imports all the components to be exported and exposed to the Window object. Because not all pages use the same set of components, you will always have a lot of unused JavaScript sitting on the page.\nGoogle Lighthouse is not happy with this</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6f1ecfd63634c8268a4cea93299b490b/9a95b/lighthouse-unused-javascript.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.84354154032747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG6AD//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAADAQEAAAAAAAAAAAAAAAAAEWEBcf/aAAgBAQABPyFZBcHD/9oADAMBAAIAAwAAABDzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQADAQEAAAAAAAAAAAAAAAEAESFxgf/aAAgBAQABPxBJynYPd8EoR//Z'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"lighthouse unused javascript\"\n        title=\"Google Lighthouse unused JavaScript\"\n        src=\"/static/6f1ecfd63634c8268a4cea93299b490b/2d017/lighthouse-unused-javascript.jpg\"\n        srcset=\"/static/6f1ecfd63634c8268a4cea93299b490b/40f63/lighthouse-unused-javascript.jpg 225w,\n/static/6f1ecfd63634c8268a4cea93299b490b/df2c7/lighthouse-unused-javascript.jpg 450w,\n/static/6f1ecfd63634c8268a4cea93299b490b/2d017/lighthouse-unused-javascript.jpg 900w,\n/static/6f1ecfd63634c8268a4cea93299b490b/bbff7/lighthouse-unused-javascript.jpg 1350w,\n/static/6f1ecfd63634c8268a4cea93299b490b/9a95b/lighthouse-unused-javascript.jpg 1649w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<p>The suggestions from Google Lighthouse to look at “React.lazy()” or “loadable-components” are not useful for this type of React implementation. Because it’s no React application. It’s a couple of React components loaded separately on the page.\nFor fixing this we need to <strong>think outside of the React box</strong>. This problem can be tackled with the following steps:</p>\n<ol>\n<li>Find out which components are used on a page</li>\n<li>Dynamically load these components using <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dynamic imports</a> </li>\n<li>Expose the components on the window object</li>\n</ol>\n<h3 id=\"find-out-which-components-are-used-on-a-page\"><a href=\"#find-out-which-components-are-used-on-a-page\" aria-label=\"find out which components are used on a page permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Find out which components are used on a page</h3>\n<p>With more regex magic we can create a array with the component names used on the page.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> namespace <span class=\"token operator\">=</span> <span class=\"token string\">'ClientX'</span>\n<span class=\"token keyword\">const</span> regex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">.</span>raw<span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>namespace<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.default.+?(?=\\W)`</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bodyHtml <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> allComponents <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>new <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>bodyHtml<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>regex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>With the code above we grab all the components referenced in the inline script tags. With the “new Set” hack we remove all the duplicate keys. </p>\n<p>Resulting in this array:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"ClientX.default.Navigation\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"ClientX.default.Section\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"ClientX.default.HeroTeaser\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"ClientX.default.USPHeader\"</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h3 id=\"dynamically-load-the-components\"><a href=\"#dynamically-load-the-components\" aria-label=\"dynamically load the components permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dynamically load the components</h3>\n<p>To allow the components to be dynamically loaded we need to change the way we currently create the index file for the components.</p>\n<p>The old way:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Navigation <span class=\"token keyword\">from</span> <span class=\"token string\">'./20_Molecules/NavigationMenu/container'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Section <span class=\"token keyword\">from</span> <span class=\"token string\">'./02_Wrappers/structure/Section'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> HeroTeaser <span class=\"token keyword\">from</span> <span class=\"token string\">'./30_Organisms/HeroTeaser/container'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">import</span> USPHeader <span class=\"token keyword\">from</span> <span class=\"token string\">'./20_Molecules/Headers/USPHeader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">import</span> BannerTeaser <span class=\"token keyword\">from</span> <span class=\"token string\">'./20_Molecules/Teasers/BannerTeaser'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n    Navigation<span class=\"token punctuation\">,</span> \n    Section<span class=\"token punctuation\">,</span> \n    HeroTeaser<span class=\"token punctuation\">,</span>  \n    USPHeader<span class=\"token punctuation\">,</span>\n    BannerTeaser\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Instead, create a component loader object that adds a async function to every component key and add it to the client entrypoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> componentLoader <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">Navigation</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/20_Molecules/NavigationMenu/container'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">Section</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/02_Wrappers/structure/Section'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">HeroTeaser</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/30_Organisms/HeroTeaser/container'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">USPHeader</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/20_Molecules/Headers/USPHeader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">BannerTeaser</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/20_Molecules/Teasers/BannerTeaser'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, create an async function that loops over the “allComponents” array, load the imports and assigning them to the window object. </p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">type</span> ReactWindow <span class=\"token operator\">=</span> Window <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token keyword\">namespace</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> reactWindow <span class=\"token operator\">=</span> window <span class=\"token keyword\">as</span> <span class=\"token builtin\">unknown</span> <span class=\"token keyword\">as</span> ReactWindow<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    reactWindow<span class=\"token punctuation\">[</span><span class=\"token keyword\">namespace</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> regex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">.</span>raw<span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>namespace<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.default.+?(?=\\W)`</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> allComponents <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>bodyHtml<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>regex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> component <span class=\"token keyword\">of</span> allComponents<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> componentsSplit <span class=\"token operator\">=</span> component<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> componentName <span class=\"token operator\">=</span> componentsSplit<span class=\"token punctuation\">[</span>componentsSplit<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n       \n        reactWindow<span class=\"token punctuation\">[</span><span class=\"token keyword\">namespace</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">[</span>componentName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> componentLoader<span class=\"token punctuation\">[</span>componentName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, if all is well, you will see a whole bunch of JavaScript files loaded in your requests instead of the one big bundle</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/92e54bd0fc4a2e684bf9795797d029f5/33f33/codesplitting-requests.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.4217772215269%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG4AD//xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABBQIv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAAAER/9oACAEBAAE/IYWMf//aAAwDAQACAAMAAAAQgA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAABBAMAAAAAAAAAAAAAAAABABEhMUFxwf/aAAgBAQABPxC5xpRQM9RJ6X//2Q=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"codesplitting requests\"\n        title=\"Code splitting requests\"\n        src=\"/static/92e54bd0fc4a2e684bf9795797d029f5/2d017/codesplitting-requests.jpg\"\n        srcset=\"/static/92e54bd0fc4a2e684bf9795797d029f5/40f63/codesplitting-requests.jpg 225w,\n/static/92e54bd0fc4a2e684bf9795797d029f5/df2c7/codesplitting-requests.jpg 450w,\n/static/92e54bd0fc4a2e684bf9795797d029f5/2d017/codesplitting-requests.jpg 900w,\n/static/92e54bd0fc4a2e684bf9795797d029f5/bbff7/codesplitting-requests.jpg 1350w,\n/static/92e54bd0fc4a2e684bf9795797d029f5/33f33/codesplitting-requests.jpg 1598w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<p>This is all great, and the amount of JavaScript loaded in total is already lower. But when running the <a href=\"https://www.npmjs.com/package/webpack-bundle-analyzer\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">webpack-bundle-analyzer</a> I notice there is some duplicate code across the bundles.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e91d48a6bb3ce82fe69908a553412216/c84ab/duplicate-code.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 86.96439348219674%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAEDAv/aAAwDAQACEAMQAAAB9W0VDRgR0QKfMMS//8QAGxAAAgEFAAAAAAAAAAAAAAAAAAERAxIxMkH/2gAIAQEAAQUCEQPFqIKmvD//xAAYEQADAQEAAAAAAAAAAAAAAAAAARIQQf/aAAgBAwEBPwGkWjuf/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAQ/9oACAECAQE/AWd//8QAFhABAQEAAAAAAAAAAAAAAAAAEDEg/9oACAEBAAY/Aisx/8QAGxAAAwACAwAAAAAAAAAAAAAAAAERIVEQQZH/2gAIAQEAAT8h6tEVlJ29EmWUUVaI04UWf//aAAwDAQACAAMAAAAQtCAD/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEQcZH/2gAIAQMBAT8QCzBw/8QAGBEAAgMAAAAAAAAAAAAAAAAAABEBEDH/2gAIAQIBAT8QQUna/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITEQUUFxwf/aAAgBAQABPxBxQm/Ec7CjsiL8k2A6BY0cc3tibe7O2afZw7T/2Q=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"duplicate code\"\n        title=\"Duplicate code\"\n        src=\"/static/e91d48a6bb3ce82fe69908a553412216/2d017/duplicate-code.jpg\"\n        srcset=\"/static/e91d48a6bb3ce82fe69908a553412216/40f63/duplicate-code.jpg 225w,\n/static/e91d48a6bb3ce82fe69908a553412216/df2c7/duplicate-code.jpg 450w,\n/static/e91d48a6bb3ce82fe69908a553412216/2d017/duplicate-code.jpg 900w,\n/static/e91d48a6bb3ce82fe69908a553412216/bbff7/duplicate-code.jpg 1350w,\n/static/e91d48a6bb3ce82fe69908a553412216/c84ab/duplicate-code.jpg 1657w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n      />\n  </span>\n  </a></p>\n<p>“Icons.tsx” and “SafeRenderDatasourceComponent.tsx” are included in multiple bundles. This is still better than having one big bundle as before but this can be easily fixed! </p>\n<p>One way of achieving this is to dynamically load “Icons.tsx” in all the components, however this is error prone and it’s a lot of manual work.</p>\n<p>My preference is to figure out which components are most likely re-used within a project and force these in a dedicated bundle. This can be done in the webpack configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">optimization<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    splitChunks<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        cacheGroups<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// custom cache group to force all components files</span>\n            <span class=\"token comment\">// in /components/common into their own chunk</span>\n            atoms<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"atoms\"</span><span class=\"token punctuation\">,</span>\n                test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/[\\\\/]components[\\\\/]10_Atoms[\\\\/]/</span><span class=\"token punctuation\">,</span>\n                enforce<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            hocs<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"hocs\"</span><span class=\"token punctuation\">,</span>\n                test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/[\\\\/]components[\\\\/]01_HOCs[\\\\/]/</span><span class=\"token punctuation\">,</span>\n\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As a result the amount of JavaScript loaded has more than halved in size on most pages!</p>\n<h3 id=\"why-is-webpack-not-splitting-the-bundles\"><a href=\"#why-is-webpack-not-splitting-the-bundles\" aria-label=\"why is webpack not splitting the bundles permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why is webpack not splitting the bundles?</h3>\n<p>While working on a project that hasn’t updated for a while these things where stopping webpack from splitting the bundles:</p>\n<ul>\n<li>Old version of typescript</li>\n<li>Deprecated loader “awesome-typescript-loader” was used, replace with <a href=\"ts-loader\">https://github.com/TypeStrong/ts-loader</a></li>\n<li>Module was not set to “esnext” in the tsconfig.json</li>\n</ul>\n<p>Fixing the items above already decreased the bundle size by quite a bit without code splitting. Probably by better treeshaking algorithms.</p>\n<h2 id=\"the-final-code\"><a href=\"#the-final-code\" aria-label=\"the final code permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The final code</h2>\n<p>With the following code in your entrypoint you combine the best of both worlds. No more render blocking script tags and a lean and mean JavaScript bundle. Enjoy your fast new project!</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=React!react\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"expose-loader?exposes=ReactDOM!react-dom\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">namespace</span> <span class=\"token operator\">=</span> <span class=\"token string\">'ClientX'</span>\n<span class=\"token keyword\">type</span> ReactWindow <span class=\"token operator\">=</span> Window <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token keyword\">namespace</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> reactWindow <span class=\"token operator\">=</span> window <span class=\"token keyword\">as</span> <span class=\"token builtin\">unknown</span> <span class=\"token keyword\">as</span> ReactWindow<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bodyHtml <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> componentLoader <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">Navigation</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/20_Molecules/NavigationMenu/container'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">Section</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/02_Wrappers/structure/Section'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">HeroTeaser</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/30_Organisms/HeroTeaser/container'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">USPHeader</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/20_Molecules/Headers/USPHeader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">VehicleGridContainer</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../src/components/30_Organisms/VehicleGrid/VehicleGrid'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 1. Only load the components that are present on the page</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    reactWindow<span class=\"token punctuation\">[</span><span class=\"token keyword\">namespace</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> regex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">.</span>raw<span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>namespace<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.default.+?(?=\\W)`</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'gm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> allComponents <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>bodyHtml<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>regex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> component <span class=\"token keyword\">of</span> allComponents<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> componentsSplit <span class=\"token operator\">=</span> component<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> componentName <span class=\"token operator\">=</span> componentsSplit<span class=\"token punctuation\">[</span>componentsSplit<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n       \n        reactWindow<span class=\"token punctuation\">[</span><span class=\"token keyword\">namespace</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">[</span>componentName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> componentLoader<span class=\"token punctuation\">[</span>componentName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 2. Execute the react hydrate after the page is loaded... </span>\n<span class=\"token function\">loadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    bodyHtml<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/(?=&lt;!--&lt;script data-react-hydrate)([\\s\\S]*?)-->/gm</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">match</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> scriptTag <span class=\"token operator\">=</span> match<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/^&lt;!--|-->$|&lt;script data-react-hydrate>|&lt;\\/script>/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Function</span><span class=\"token punctuation\">(</span>scriptTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hydrating error:'</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">,</span> scriptTag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","timeToRead":9,"frontmatter":{"title":"Speed up your Sitecore React implementation","date":"February 11, 2021","spoiler":"With 2 easy fixes"},"fields":{"slug":"/speed-up-your-sitecore-react-implementation/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/speed-up-your-sitecore-react-implementation/","previous":{"fields":{"slug":"/webcomponents-intellisense/","langKey":"en","directoryName":"webcomponents-intellisense"},"frontmatter":{"title":"Get intellisense on your Stencil webcomponents in VS Code"}},"next":null,"translations":[],"translatedLinks":[]}}}