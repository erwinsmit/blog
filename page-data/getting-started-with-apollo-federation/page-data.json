{"componentChunkName":"component---src-templates-blog-post-js","path":"/getting-started-with-apollo-federation/","webpackCompilationHash":"d76f921222e0095d1a0e","result":{"data":{"site":{"siteMetadata":{"title":"Erwin Smit blog","author":"Erwin Smit"}},"markdownRemark":{"id":"d4d27f2f-83fd-554f-b00e-8b33f8c6c873","html":"<h2 id=\"why\"><a href=\"#why\" aria-label=\"why permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why?</h2>\n<p>At a project I’m working on we have to build a single page application with authentication that needs to query data from multiple data services. </p>\n<p>There are also a lot of examples where we need to ‘stitch’ these services together. Let’s have a look at the domain model and the corresponding services:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/02acf174e7d3516107da7a76b05b4e10/5c089/spaData.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 522px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 100.95785440613028%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe6g2ggAP//EABcQAAMBAAAAAAAAAAAAAAAAAAAQIUH/2gAIAQEAAQUCI48P/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAFBABAAAAAAAAAAAAAAAAAAAAMP/aAAgBAQAGPwIf/8QAGRAAAgMBAAAAAAAAAAAAAAAAEBEAASFR/9oACAEBAAE/IVTiTRgOp0//2gAMAwEAAgADAAAAEOAAPP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABoQAQADAAMAAAAAAAAAAAAAAAEAESExYXH/2gAIAQEAAT8QdTQsSoALvWDmaQLqo5s0BZXkC4YYDtlYjs//2Q=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"alt text\"\n        title=\"data setup\"\n        src=\"/static/02acf174e7d3516107da7a76b05b4e10/5c089/spaData.jpg\"\n        srcset=\"/static/02acf174e7d3516107da7a76b05b4e10/40f63/spaData.jpg 225w,\n/static/02acf174e7d3516107da7a76b05b4e10/df2c7/spaData.jpg 450w,\n/static/02acf174e7d3516107da7a76b05b4e10/5c089/spaData.jpg 522w\"\n        sizes=\"(max-width: 522px) 100vw, 522px\"\n      />\n  </span>\n  </a></p>\n<p>Note that I’m not really a pro drawing things with draw.io…\nBut you get the point, if we fetch service requests for example. We also have to get the related entity &#x26; portfolio for every single service request. Currently we do this with separate api calls and it works but it complicates loading states and it makes the frontend application harder to work with.</p>\n<p>Would it not be nice to get a list of service requests, without having to create 3 api calls from the frontend? Of course this can all be done on the server, but if the requirements change all needs to be updated. For example, if the business decides it doesn’t want entity information on a service request we can remove it from the frontend but the server will still fetch all the data, what a waste! This is where graphql shines, there is a clear connection between the client and the server on the data it actually needs. </p>\n<p>Graphql provides a nice query language for querying the date you want with nested objects supported as well. </p>\n<p>A query for fetching service requests with the related entities and portfolios would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> getServiceRequests <span class=\"token punctuation\">{</span>\n    ServiceRequests <span class=\"token punctuation\">{</span>\n        entity <span class=\"token punctuation\">{</span>\n            name<span class=\"token punctuation\">,</span>\n            address\n        <span class=\"token punctuation\">}</span>\n        portfolio <span class=\"token punctuation\">{</span>\n            name<span class=\"token punctuation\">,</span>\n            address\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        name   \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This query will return a list with the service requests but with the entity and portfolio objects already embedded, nice!</p>\n<p>To actually perform this query and stitch all the data together we can use “Apollo Federation”:\n<a href=\"https://www.apollographql.com/docs/apollo-server/federation/introduction/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.apollographql.com/docs/apollo-server/federation/introduction/</a></p>\n<h2 id=\"watchlist-sideproject\"><a href=\"#watchlist-sideproject\" aria-label=\"watchlist sideproject permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Watchlist sideproject</h2>\n<p>I decided to have a play with this using a hobby project. This project called “watchlist” allows me to search for films and add them to my watchlist. I would like to expand it with ratings and sharing functionality but that’s for later.</p>\n<p>I decided on using themoviedb.org as a source for the films and firebase.google.com for saving films to my watchlist. </p>\n<p>The watchlist items are saved in firebase in this structure:</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d58f3eccffdbcec8e7faf6b15bfd4ba1/bd1e1/firebase.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 356px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 103.37078651685394%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACz0lEQVQ4y41VS04yQRjkXi5NvIF7ExfewRuYuPA2rly5VaNGUGAeMAzz4P0UBKbLqgYU/gC/JF96aHqqq76qbnLY8zHGrB+WY5bB/G8tP7laLUCtVkMUxfA9D/V6hNl8/rtQtVgswaZTGNfF4vUVC8fB4v0dWRj+rFXl6pxI05TVQJokiFmz2QpwxcpWpQJzdwcTBMhIIOM7Gdeaft9u+gPY7nTQ73XhcEfH9VCtVrf1zGbAzQ3w8IC97fnVjlxGFjO+1Ov10CW4R9ntdhsdVtpqIXVcJLe36IxGaHa7GFBudnkJc3oKc3EBc34OXF8vQQW4JDFDl4s77RaZlskyQKXio1qpwmeFBI8aDfj39xhcXQEEw/ExzMkJzNERcHYGM5ksTdl06OvryzL9HI/guTKojoD9klme56L88QGnXEYhrCPP1sx3Sd60XYCDwQCTyaeVHcexNanRbKLFSpLYJqJJQ4Y0w9B9GyfVCiO3K0vr3RShYrGI4XCIEXtYI6smgWGwFRVsZHaLYYN9EoAYym2xCZVRMk3ThH2t2PJZCVmuQbaCvQkoiW9vb5Q+tVL1XcD1KLKAATMY8Vks1ZL1e3sBQ4b8+fkZ4/GY/UpoDI0oO5QeolQqwaVRmlN297VqC7DDhZIkyT3GqMUcygjNeZ5vN5HzNW7caDShDB9kqMUvLy+YMlMxpYmxa1mWKFfnvW6DryhpVH63zNkl+ZUnQVnUywISoHqo0WfYXTJ1eUzVlj9JlgmKieSq+evLQ5vFcWLXhKu5PzGU5H6/Zx0OeSJKpSJZkZ3v22eZU9JpyeftmoOAioRiY0McVG3+1CttJOZyOeCoUujNrgt2c0LZEsBoNEREg+Sqwq1LOE5S+11tWIY+pMvmMEMF9+npyd48j4+PZORYiXnKKxQKtpRLrdPYbncOA+pyWLunhs/5V6CsLXgJLPisOZXm1r/9K/kbH543qVb27uEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"alt text\"\n        title=\"data setup\"\n        src=\"/static/d58f3eccffdbcec8e7faf6b15bfd4ba1/bd1e1/firebase.png\"\n        srcset=\"/static/d58f3eccffdbcec8e7faf6b15bfd4ba1/064a4/firebase.png 225w,\n/static/d58f3eccffdbcec8e7faf6b15bfd4ba1/bd1e1/firebase.png 356w\"\n        sizes=\"(max-width: 356px) 100vw, 356px\"\n      />\n  </span>\n  </a></p>\n<p>Firebase is using a folder structure, userId is used to group all the watchlist items under the correct user. This way I can simply query everything from a specific directory knowing that it’s all scoped to the correct user.</p>\n<p>Eventually I would like to query films and find out from each film if it’s added to watchlist yet. </p>\n<p>The other way round I want to query my watchlist and have all the film information embbeded without having to query the filmservice separately. </p>\n<h2 id=\"setting-up-the-apollo-gateway\"><a href=\"#setting-up-the-apollo-gateway\" aria-label=\"setting up the apollo gateway permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setting up the apollo gateway</h2>\n<p>To use Apollo federation you have to create separate services which can be tied together with a “gateway”.</p>\n<p>The gateway looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> gateway <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloGateway</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  serviceList<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"watchListItems\"</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://localhost:5002\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"films\"</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://localhost:5003\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">buildService</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> url <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthenticatedDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Because I can only return watchlistitems if the user is authenticated I have to pass an Auth token from my frontend application. In the gateway this token is translated into a userId. The userId is placed on the context, context is a mechanism that allows apollo server to add variables to a global scope which can be accessed anywhere within the scope of the request. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  gateway<span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">context</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> req<span class=\"token punctuation\">,</span> context <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>authorization <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> firebaseApp<span class=\"token punctuation\">.</span><span class=\"token function\">auth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">verifyIdToken</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        userId<span class=\"token punctuation\">:</span> user<span class=\"token punctuation\">.</span>user_id\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        userId<span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  subscriptions<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The context only lives within the ‘gateway’ not in the underlying services. So after the userId is extracted from the token we pass it through using the http headers.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthenticatedDataSource</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RemoteGraphQLDataSource</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">willSendRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> request<span class=\"token punctuation\">,</span> context <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      request<span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'userid'</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"creating-the-films-service\"><a href=\"#creating-the-films-service\" aria-label=\"creating the films service permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating the films service</h2>\n<p>The typedefs for this service are as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">  <span class=\"token keyword\">type</span> <span class=\"token class-name\">Film</span> <span class=\"token directive function\">@key</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">fields</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> ID<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">posterPath</span><span class=\"token punctuation\">:</span> String\n    <span class=\"token attr-name\">title</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">watchListItem</span><span class=\"token punctuation\">:</span> WatchListItem <span class=\"token directive function\">@provides</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">fields</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"filmId\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  extend <span class=\"token keyword\">type</span> <span class=\"token class-name\">WatchListItem</span> <span class=\"token directive function\">@key</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">fields</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"filmId\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">filmId</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span> <span class=\"token directive function\">@external</span>\n    <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> ID<span class=\"token operator\">!</span> <span class=\"token directive function\">@external</span>\n  <span class=\"token punctuation\">}</span>\n   \n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">Query</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">films</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Film<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>By adding @key(fields: “id”) to Film we ensure this type will be able to referenced by other services.\nIn the Film type there is a reference to WatchListItem, because this will be resolved by other services we add the @provides keyword with the field “filmId” which can be used to resolve the type.</p>\n<p>The WatchListItem item lives in another service, so we need to create an extension in this services. That’s done by the “extend type” keyword. </p>\n<p>Resolvers:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> resolvers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">films</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentValue<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> dataSources <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> dataSources<span class=\"token punctuation\">.</span>filmsApi<span class=\"token punctuation\">.</span><span class=\"token function\">getTrendingFilms</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  Film<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">__resolveReference</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reference<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> dataSources <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> dataSources<span class=\"token punctuation\">.</span>filmsApi<span class=\"token punctuation\">.</span><span class=\"token function\">getFilmById</span><span class=\"token punctuation\">(</span>reference<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">watchListItem</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">film<span class=\"token punctuation\">,</span> args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> __typename<span class=\"token punctuation\">:</span> <span class=\"token string\">\"WatchListItem\"</span><span class=\"token punctuation\">,</span> filmId<span class=\"token punctuation\">:</span> film<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">:</span> args<span class=\"token punctuation\">.</span>userId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>To resolve the watchListItem type we need to add a resolver that provides the correct fields to the external service. That’s done with the this line <code class=\"language-text\">return { __typename: &quot;WatchListItem&quot;, filmId: film.id, userId: args.userId };</code></p>\n<p>If we want other services to consume the Film type we need the __resolveReference method within the type resolver. Within this method the related dataservice method is attached. </p>\n<p>After the types and the resolvers are set up correctly the federated service is created:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">dataSources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      filmsApi<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FilmsApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  schema<span class=\"token punctuation\">:</span> <span class=\"token function\">buildFederatedSchema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> \n    typeDefs<span class=\"token punctuation\">,</span> \n    resolvers\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"creating-the-watchlist-service\"><a href=\"#creating-the-watchlist-service\" aria-label=\"creating the watchlist service permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating the watchlist service</h2>\n<p>Because we need the userId within this service we get the userId from the requestHeaders and add it to the context. This ensures it’s always available within all the resolvers. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">dataSources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            watchListApi<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WatchListApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    schema<span class=\"token punctuation\">:</span> <span class=\"token function\">buildFederatedSchema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> typeDefs<span class=\"token punctuation\">,</span> resolvers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">context</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> req <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> userId <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>userid<span class=\"token punctuation\">;</span>\n    \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            userId<span class=\"token punctuation\">:</span> userId\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In the typedefs an external reference to type Film is added using the @provides keyword. In the external type we only set the @external id. Note that within the query it’s possible to also request all the other fields within the Film type. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  type WatchListItem @<span class=\"token function\">key</span><span class=\"token punctuation\">(</span>fields<span class=\"token punctuation\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token constant\">ID</span><span class=\"token operator\">!</span>\n    filmId<span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span>\n    film<span class=\"token punctuation\">:</span> Film @<span class=\"token function\">provides</span><span class=\"token punctuation\">(</span>fields<span class=\"token punctuation\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  extend type Film @<span class=\"token function\">key</span><span class=\"token punctuation\">(</span>fields<span class=\"token punctuation\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token constant\">ID</span><span class=\"token operator\">!</span> @external\n  <span class=\"token punctuation\">}</span>\n\n  type Query <span class=\"token punctuation\">{</span>\n    watchListItems<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>WatchListItem<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Within the resolvers we specify how the WatchListItem is resolved when it’s requested from another service. Within the film type we tell the resolver to try to get it from another service by only returning <code class=\"language-text\">{ __typename: &quot;Film&quot;, id: watchListItem.filmId };</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> resolvers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function-variable function\">watchListItems</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parentValue<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> dataSources<span class=\"token punctuation\">,</span> userId <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> dataSources<span class=\"token punctuation\">.</span>watchListApi<span class=\"token punctuation\">.</span><span class=\"token function\">getWatchListItems</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    WatchListItem<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">async</span> <span class=\"token function\">__resolveReference</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span>filmId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">.</span>dataSources<span class=\"token punctuation\">.</span>watchListApi<span class=\"token punctuation\">.</span><span class=\"token function\">getWatchListItemByFilmId</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">,</span> filmId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">film</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">watchListItem</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> __typename<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Film\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> watchListItem<span class=\"token punctuation\">.</span>filmId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now with this setup we can execute queries that will consume both services (see below for some examples). When using the graphql explorer we add the auth token to the http header to get the results we want.\n<a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dfb38a435aebdc1a9588d1c6de4d3422/fddbb/getFilms.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 736px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 108.15217391304348%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAADHklEQVQ4y41V23LiRhTUo9cYhMCWZsTaIO5IQjfAYAxm7b04qUqlat/2A/Y1f5SXPOQ7Oz0z3NfZ5KFLSCX16e5z5mAFT9/QzFaoBmPUhw9wuyncXgb7doBKkMELH1BrhSg3+qgQF/UG3l2//1dYwfJ3tGcv/HCBZvECMZrDjxZwB1O4owVEtITTTlkw0UXLt0NUfgLrppfDG85w05/AD+9R7030vQznaGVreKN7ON0Janxe709xPZgd0P8Rls3K9U6GWjvTSq57BS4bIyxfv+LPv/5GsvkNd8kMzXwNMV7Bo+KfwaoFKRxm5gxz2M0x7NYYpdsQ7XyFb9//QDB5hoiXaBQfSbjWH7kRs1ZX5nsOq9pKYHcS1NIp7HaiofIqvR/hohHiZvuiN36CyJjxhEqnRLpixgcib1vAUh/bDNuJClQHmYF61oz5wRxe/MgXF/DSD/Bnv0IuPsOff4YkoZc8stByT6YtO4FRVKXVyl1s0DRQTdi9rPIT6TNJeC2ejFLCSx/39jVhdUuoCFR+O+wIBRWq0fFJ5IZLPZcmQ0PgxWcKd2oqrbcJD5afIaevkPMPEPMN72mZjfOKrfXQNMo6J/mBMDKqRLKByNnpyUfIjNbjJxZiseHitMtvkZ1YjlT1JSQzdCM1h6oRbyAxOFH4JmFqbIkpLc8/EWyIsslmaOQ762v93n8S6gzZAJGT8P5Vj42kbWXZU5bVLB7h0JQjnHdZ5bi3HD4a2+p5bLrsHh+9/6Vw2xSpmqJOyZTEGcdpZubxZGzKdxGueHYV1O+D0uhosLnGeFLk5AttG8tivDEqo4dTwlorguBykIMC10GMkuyh5BOyi1q32A+2TKgk3m4b3dXVnkhbDs3SsJzmCLKfwR8WUOSXoqNx4QVwOrkm1IuWi0Gf5eULO80NlJpsjxeEnsNLKrkSXZTdLmyvB1v2UfUHqMshbrhYjzP0p7/Q8if4D7R9v9GjIvL1/vhpy1e0p/4rFJFCmZYrfh8Of9epUFemQm97VRvIjXkd8z7eQj83sEpUdyk7e6s7vCNUjqqgQd9kq/M9g3/AP9GBd30bKpO7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"alt text\"\n        title=\"get films\"\n        src=\"/static/dfb38a435aebdc1a9588d1c6de4d3422/fddbb/getFilms.png\"\n        srcset=\"/static/dfb38a435aebdc1a9588d1c6de4d3422/064a4/getFilms.png 225w,\n/static/dfb38a435aebdc1a9588d1c6de4d3422/44727/getFilms.png 450w,\n/static/dfb38a435aebdc1a9588d1c6de4d3422/fddbb/getFilms.png 736w\"\n        sizes=\"(max-width: 736px) 100vw, 736px\"\n      />\n  </span>\n  </a></p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fd4c44457a1b9d767879f286688ef1d1/0336a/getWatchlistitems.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 701px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 107.9885877318117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAADD0lEQVQ4y41Uy3LaQBDUKeWyzdtGWoEBYyxAT4QQ4g1+xYkPrlT+J4ccckjlkE/uzOxKgDGp8qFrFolt9UzPjFbpzXDZCXAqOqgnr+gmj7DiDVqDBQpNB+XuBNXbAfJ1i9DFmd7CSVngpFI7Cs3wNxD2BOVOiOb0Fc3oHleDJWEFvZ/A8Fa4sCIUr32U2gHyDRu5moUckR+DJpwETVJj0OWmN4WgWO3FqLt0thOY9L7cGaLUiSQqtwRr9F9o/OUCIX/tIdf2kG/7Us0nw8L8+Tt+/v4LK3kCf7hGH9SdGXTKSHfS8wG0MqVRsgYo+ZRWl2IvlKmdmF1MP3/Dj19/cBM/oBFM0KJoDO5hhI+yFLo9RbVPsHdQClueJCpyja4c5JuufHZa76PQDtWfnTn04A4iJNJwCWO0ghFxXEKnkrG6HWHDRbEfohyMZGSyjPSyN4bhzkkJpekuIIbPMIM1kdAHQiIKKLozpTYjLLJCbg2qY4HR8rakF90xXaBLPsGbQcRPMJOvFB+VQlbnpe8JGterfDOgnnMlQYYdYawuDBcyNUF9KiaU+vJeEupDIk3BZ40vssqMZB9bhewgFV/I1PeM4Nijxu9Nt8+1Q0XvCWNZQ66T8JcyVqlHZYrBHtgUbpv9y8cVxjtTvDXM8QvM4QbGmNKcrGHE5HZC0VfqtUOSY4R6qpBViBG5HL+QKQ/KEFbHNaRWYtM+RsimRMvUFCJKaP5nd8rlA3yM0FF9JpjYWyrFA6X63aTkD9rlWNtwDQ1HmcKF59Skai81xJ/vJuUjCqUpNju7pkmhRcETEi1kb2apSrXvFToKDQe5FCrl+TYlEX2BGT1TI2+UOl59bI6dEdJSLDVtlFu2jNWOj3p/hIY7RuXakbtQ9xdqCZAyc0YuLwirJ9UyjPFqe9bOaPWfm7fgmIF/81bmMy9UPU1Z1tJT7aGHu6XwZh+e125RqHVxIXqopCgIC0bNgW6SYtrCemqK6S1kg++PX2bG1mWlqINT4+aNSgY/Y4Vy9FhhsJH7UESc3jKdEjUpmSn/ANJ5emd6XYSfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"alt text\"\n        title=\"get watchlistitems\"\n        src=\"/static/fd4c44457a1b9d767879f286688ef1d1/0336a/getWatchlistitems.png\"\n        srcset=\"/static/fd4c44457a1b9d767879f286688ef1d1/064a4/getWatchlistitems.png 225w,\n/static/fd4c44457a1b9d767879f286688ef1d1/44727/getWatchlistitems.png 450w,\n/static/fd4c44457a1b9d767879f286688ef1d1/0336a/getWatchlistitems.png 701w\"\n        sizes=\"(max-width: 701px) 100vw, 701px\"\n      />\n  </span>\n  </a></p>\n<p>In future blogposts I would like to dive deeper into the apollo-client and optimising the dataservices. Explore the caching options both on the client and on the server.</p>\n<p>For now the rest of the source code is available on:\n<a href=\"https://github.com/erwinsmit/watchlist\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/erwinsmit/watchlist</a></p>","timeToRead":6,"frontmatter":{"title":"Exploring the apollo graphql stack","date":"February 15, 2020","spoiler":"Let's investigate apollo federation first"},"fields":{"slug":"/getting-started-with-apollo-federation/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/getting-started-with-apollo-federation/","previous":{"fields":{"slug":"/local-npm package-to-share-between-react-apps/","langKey":"en","directoryName":"local-npm package-to-share-between-react-apps"},"frontmatter":{"title":"Creating local npm package for sharing between multiple react applications"}},"next":{"fields":{"slug":"/make-your-sxa-site-perform/","langKey":"en","directoryName":"make-your-sxa-site-perform"},"frontmatter":{"title":"How to make your Sitecore SXA site perform"}},"translations":[],"translatedLinks":[]}}}