<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/a34f9d1faa5f3315-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/blog/action-error.png"/><link rel="preload" as="image" href="/blog/blob-storage.png"/><link rel="preload" as="image" href="/blog/new-architecture.png"/><link rel="stylesheet" href="/_next/static/css/87cbc7cac530fcf5.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/3a398bc4ce4edcc7.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-8af1d2e0ff41d756.js"/><script src="/_next/static/chunks/4bd1b696-05ac3765304a89c0.js" async=""></script><script src="/_next/static/chunks/215-c1a7d2d931604563.js" async=""></script><script src="/_next/static/chunks/main-app-e5edefe120089e16.js" async=""></script><script src="/_next/static/chunks/231-015614b9a59ae6eb.js" async=""></script><script src="/_next/static/chunks/173-e6c8bf506bfb93ff.js" async=""></script><script src="/_next/static/chunks/app/layout-3afd5ec87fcd9128.js" async=""></script><script src="/_next/static/chunks/app/not-found-081a5836cd82c2ca.js" async=""></script><meta name="next-size-adjust"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><title>Sitecore JSS Next.js on Azure Static Web Apps</title><meta name="description" content="Erwin Smit - Freelance frontend developer / fullstack developer"/><meta property="og:title" content="Sitecore JSS Next.js on Azure Static Web Apps"/><meta property="og:description" content="Erwin Smit - Freelance frontend developer / fullstack developer"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Sitecore JSS Next.js on Azure Static Web Apps"/><meta name="twitter:description" content="Erwin Smit - Freelance frontend developer / fullstack developer"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="bg-gray-100 [object Object]"><header class="bg-blue-600 text-white shadow-md"><div class="container mx-auto px-4 py-4"><div class="flex justify-between items-center"><a href="/"><div class="flex items-center space-x-4 bg-blue-700 rounded-full py-2 px-4"><img alt="Your Name" loading="lazy" width="40" height="40" decoding="async" data-nimg="1" class="rounded-full border-2 border-white" style="color:transparent;height:40px;width:40px;object-fit:cover" src="/assets/selfie.jpg"/><span class="font-semibold text-lg text-white">Erwin Smit</span></div></a><nav class="flex-grow"><ul class="flex justify-end space-x-6"><li><a class="hover:text-blue-200 transition duration-150 ease-in-out" href="/">About me</a></li><li><a class="hover:text-blue-200 transition duration-150 ease-in-out" href="/blog">Blog</a></li></ul></nav></div></div></header><main class="min-h-screen"><article class="max-w-7xl mx-auto px-8 my-12"><h1 class="w-full relative mb-8 text-6xl font-extrabold tracking-normal text-center title-font"><span class="bg-clip-text text-transparent bg-gradient-to-b from-blue-600 to-blue-500">Sitecore JSS Next.js on Azure Static Web Apps</span></h1><div class="flex items-center justify-center mb-16"><p class="text-base font-medium text-gray-600 group-hover:text-gray-800"><time dateTime="2022-10-26">October	26, 2022</time></p></div><div class="prose lg:prose-xl max-w-none prose-pre:p-0"><p>Azure <a href="https://techcommunity.microsoft.com/t5/apps-on-azure-blog/extending-next-js-support-in-azure-static-web-apps/ba-p/3627975">announced a few weeks ago</a> that they now also support the non-static features from Next.js (e.g. <a href="https://nextjs.org/docs/basic-features/data-fetching/incremental-static-regeneration">Incremental Static Regeneration</a> &amp; <a href="https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props">Server Side Rendering</a>) on Azure Static Web Apps(SWA).</p>
<p>Although I&#x27;ve already had a way of <a href="/sitecore-nextjs-without-vercel">hosting JSS Next.js</a> on Azure. I was curious to see if I was able to deploy JSS Next.js using <strong>Azure SWA</strong> (I use <strong>SWA</strong> as abbreviation for Static Web App from here).</p>
<p>Of course nothing is easy, so let&#x27;s run through the problems I&#x27;ve had.</p>
<h2>Problem 1, getting it deployed</h2>
<p>I created a new Sitecore JSS project using the <a href="https://doc.sitecore.com/xp/en/developers/hd/190/sitecore-headless-development/walkthrough--creating-a-jss-next-js-application-with-the-jss-cli.html">JSS CLI</a>. After that I followed the steps to <a href="https://learn.microsoft.com/en-us/azure/static-web-apps/deploy-nextjs-hybrid">deploy a hybrid Next.js</a> website to Azure. This connects to your GitHub repo and automatically creates a GitHub action. There I got the first problem:</p>
<p><code>SystemError [ERR_SYSTEM_ERROR]: A system error occurred: uv_os_get_passwd returned ENOENT (no such file or directory)</code>.</p>
<p><img src="/blog/action-error.png" alt="GitHub action error"/></p>
<p>So the <code>username-sync</code> package is the culprit, this is a dependency from the <a href="https://www.npmjs.com/package/sync-disk-cache">sync-disk-cache</a> npm package. Sitecore JSS is using this npm package to solve the <a href="https://nextjs.org/docs/advanced-features/preview-mode#previewdata-size-limits">2kb preview data problem</a>.</p>
<p>So apparently the <code>username-sync</code> package doesn&#x27;t play nicely on GitHub actions. I worked around it by <a href="https://github.com/erwinsmit/swa-jss/tree/master/username-sync">overwriting this package</a> with a hardcoded value.</p>
<p>Before the <code>next:build</code> I copied the patch into the node_modules directory overwriting the original npm package.</p>
<pre><code class="hljs language-json">package.json
<span class="hljs-attr">&quot;build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ncp username-sync node_modules/username-sync &amp;&amp; npm-run-all --serial bootstrap next:build&quot;</span>
</code></pre>
<p>And it worked! We now have a nice fast frontend with a fast simple pipeline. But then I went to the Experience Editor...</p>
<h2>Problem 2, EditingDataDiskCache doesn&#x27;t work</h2>
<p>When hitting the Experience Editor I noticed the API routes were returning 500 errors, in Azure Application Insights I got the following errors:</p>
<p><code>Editing data cache miss for key 9f1a55c0-ad8b-51e4-8064-6e427bf80000-y3iv6vzpa3 at /tmp/if-you-need-to-delete-this-open-an-issue-sync-disk-cache/editing-data</code></p>
<p>I know from <a href="/sitecore-jss-on-azure-functions/">experience</a> that these errors are coming from the <a href="https://github.com/Sitecore/jss/blob/dev/packages/sitecore-jss-nextjs/src/editing/editing-data-cache.ts">EditingDataDiskCache</a>. Apparently with Azure SWA you can&#x27;t write and read stuff to the TMP directory. Also configuring a different TMP directory did not fix this problem.</p>
<p>So, I had to find a different way of saving the <em>Preview data</em> somewhere. In Azure this can be done cheap and easy with a Storage account resource. I created a Storage account, added a container to the Blob Storage and now I just had to find a way to read/write from there.</p>
<p><img src="/blog/blob-storage.png" alt="Blob storage"/></p>
<p>Luckily Azure has good <a href="https://learn.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-nodejs?tabs=environment-variable-windows#upload-blobs-to-a-container">documentation</a> on this and a <a href="https://www.npmjs.com/package/@azure/storage-blob">NPM package</a>.</p>
<p>With this package it&#x27;s as easy as this to upload blobs.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EditingDataBlobCache</span> implements <span class="hljs-title class_">EditingDataCache</span> {
  private <span class="hljs-attr">containerClient</span>: <span class="hljs-title class_">ContainerClient</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> blobServiceClient = <span class="hljs-title class_">BlobServiceClient</span>.<span class="hljs-title function_">fromConnectionString</span>(
      process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_STORAGE_CONNECTION_STRING</span>
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerClient</span> = blobServiceClient.<span class="hljs-title function_">getContainerClient</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_BLOB_CONTAINER</span>);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">set</span>(<span class="hljs-attr">key</span>: string, <span class="hljs-attr">editingData</span>: <span class="hljs-title class_">EditingData</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">const</span> blobName = key + <span class="hljs-string">&#x27;.txt&#x27;</span>;
    <span class="hljs-keyword">const</span> blockBlobClient = <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerClient</span>.<span class="hljs-title function_">getBlockBlobClient</span>(blobName);
    <span class="hljs-comment">// Upload data to the blob</span>
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(editingData);
    <span class="hljs-keyword">const</span> uploadBlobResponse = <span class="hljs-keyword">await</span> blockBlobClient.<span class="hljs-title function_">upload</span>(data, data.<span class="hljs-property">length</span>);
  }
</code></pre>
<p>All I had to do was create a custom <a href="https://github.com/erwinsmit/swa-jss/blob/master/src/lib/editing/editing-data-cache.ts">EditingDataDiskCache</a> implementation and plug that into the Sitecore JSS code. The plugging is well supported by the JSS codebase, the implementation can be passed as follows on the <code>api/editing/data/[key].ts</code> API route:</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">EditingDataDiskCache</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;lib/editing/editing-data-cache&quot;</span>;
<span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditingDataMiddleware</span>({ <span class="hljs-attr">editingDataCache</span>: editingDataCache }).<span class="hljs-title function_">getHandler</span>();
</code></pre>
<p>So the architecture looks as illustrated below. This is an updated diagram from the <a href="https://doc.sitecore.com/xp/en/developers/hd/190/sitecore-headless-development/architecture-and-apis-for-integrating-jss-next-js-apps-with-sitecore-editors.html">Sitecore documentation</a> where the regular disk cache is replaced with our own implementation.</p>
<p><img src="/blog/new-architecture.png" alt="New architecture"/></p>
<p>And now it all works! So do I prefer using Azure SWA over my own custom <a href="/sitecore-nextjs-without-vercel">solution</a>? I think I do, mainly for these reasons:</p>
<ul>
<li>The API routes are automatically transformed into Azure Functions</li>
<li>Deploying is much easier, no large custom pipelines, just use the pipeline from Azure SWA, configure the environment variables and you&#x27;re good to go!</li>
</ul>
<p>Sometimes you have to kill your babies. At least I&#x27;ve learned a lot about Next.js &amp; JSS in the process!</p>
<p>For the code, have a look at my <a href="https://github.com/erwinsmit/swa-jss">repo</a>. The required customizations can be found in the folder <a href="https://github.com/erwinsmit/swa-jss/tree/master/src/lib/editing">src/lib/editing</a>.</p></div></article></main><section class="bg-gray-800 text-white py-12"><div class="container mx-auto px-4 text-center"><h2 class="text-2xl font-bold mb-6" id="connect">Connect With Me</h2><div class="flex justify-center space-x-6"><a href="https://github.com/erwinsmit" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg><span class="sr-only">GitHub</span></a><a href="https://www.linkedin.com/in/erwin-smit-40957840/" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg><span class="sr-only">LinkedIn</span></a></div></div></section><script src="/_next/static/chunks/webpack-8af1d2e0ff41d756.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"4:\"$Sreact.fragment\"\n5:I[7256,[\"231\",\"static/chunks/231-015614b9a59ae6eb.js\",\"173\",\"static/chunks/173-e6c8bf506bfb93ff.js\",\"185\",\"static/chunks/app/layout-3afd5ec87fcd9128.js\"],\"default\"]\n6:I[9275,[],\"\"]\n7:I[1343,[],\"\"]\n8:I[4703,[\"231\",\"static/chunks/231-015614b9a59ae6eb.js\",\"160\",\"static/chunks/app/not-found-081a5836cd82c2ca.js\"],\"default\"]\na:I[3120,[],\"OutletBoundary\"]\nc:I[3120,[],\"MetadataBoundary\"]\ne:I[3120,[],\"ViewportBoundary\"]\n10:I[6130,[],\"\"]\n1:HL[\"/_next/static/media/a34f9d1faa5f3315-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/87cbc7cac530fcf5.css\",\"style\"]\n3:HL[\"/_next/static/css/3a398bc4ce4edcc7.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"m73wy14q1bp74FhsBDcgE\",\"p\":\"\",\"c\":[\"\",\"blog\",\"sitecore-jss-nextjs-on-azure-static-web-app\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"sitecore-jss-nextjs-on-azure-static-web-app\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"sitecore-jss-nextjs-on-azure-static-web-app\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$4\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/87cbc7cac530fcf5.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"apple-touch-icon\",\"sizes\":\"180x180\",\"href\":\"/favicon/apple-touch-icon.png\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"sizes\":\"32x32\",\"href\":\"/favicon/favicon-32x32.png\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"sizes\":\"16x16\",\"href\":\"/favicon/favicon-16x16.png\"}],[\"$\",\"link\",null,{\"rel\":\"manifest\",\"href\":\"/favicon/site.webmanifest\"}],[\"$\",\"link\",null,{\"rel\":\"mask-icon\",\"href\":\"/favicon/safari-pinned-tab.svg\",\"color\":\"#000000\"}],[\"$\",\"link\",null,{\"rel\":\"shortcut icon\",\"href\":\"/favicon/favicon.ico\"}],[\"$\",\"meta\",null,{\"name\":\"msapplication-TileColor\",\"content\":\"#000000\"}],[\"$\",\"meta\",null,{\"name\":\"msapplication-config\",\"content\":\"/favicon/browserconfig.xml\"}],[\"$\",\"meta\",null,{\"name\":\"theme-color\",\"content\":\"#000\"}],[\"$\",\"link\",null,{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"/feed.xml\"}]]}],[\"$\",\"body\",null,{\"className\":\"bg-gray-100 [object Object]\",\"children\":[[\"$\",\"$L5\",null,{}],[\"$\",\"main\",null,{\"className\":\"min-h-screen\",\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"$L8\",null,{}],\"notFoundStyles\":[]}]}],[\"$\",\"section\",null,{\"className\":\"bg-gray-800 text-white py-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"container mx-auto px-4 text-center\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"text-2xl font-bold mb-6\",\"id\":\"connect\",\"children\":\"Connect With Me\"}],[\"$\",\"div\",null,{\"className\":\"flex justify-center space-x-6\",\"children\":[[\"$\",\"a\",null,{\"href\":\"https://github.com/erwinsmit\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"className\":\"hover:text-blue-400 transition-colors\",\"children\":[[\"$\",\"svg\",null,{\"ref\":\"$undefined\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":32,\"height\":32,\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":2,\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"lucide lucide-github\",\"children\":[[\"$\",\"path\",\"tonef\",{\"d\":\"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4\"}],[\"$\",\"path\",\"9comsn\",{\"d\":\"M9 18c-4.51 2-5-2-7-2\"}],\"$undefined\"]}],[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"GitHub\"}]]}],[\"$\",\"a\",null,{\"href\":\"https://www.linkedin.com/in/erwin-smit-40957840/\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"className\":\"hover:text-blue-400 transition-colors\",\"children\":[[\"$\",\"svg\",null,{\"ref\":\"$undefined\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":32,\"height\":32,\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":2,\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"lucide lucide-linkedin\",\"children\":[[\"$\",\"path\",\"c2jq9f\",{\"d\":\"M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z\"}],[\"$\",\"rect\",\"mk3on5\",{\"width\":\"4\",\"height\":\"12\",\"x\":\"2\",\"y\":\"9\"}],[\"$\",\"circle\",\"bt5ra8\",{\"cx\":\"4\",\"cy\":\"4\",\"r\":\"2\"}],\"$undefined\"]}],[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"LinkedIn\"}]]}]]}]]}]}]]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$4\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"sitecore-jss-nextjs-on-azure-static-web-app\",\"d\"],[\"$\",\"$4\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$4\",\"c\",{\"children\":[\"$L9\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/3a398bc4ce4edcc7.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$La\",null,{\"children\":\"$Lb\"}]]}],{},null]},null]},null]},null],[\"$\",\"$4\",\"h\",{\"children\":[null,[\"$\",\"$4\",\"SX-lSKbSnI7MNWF5rH8NT\",{\"children\":[[\"$\",\"$Lc\",null,{\"children\":\"$Ld\"}],[\"$\",\"$Le\",null,{\"children\":\"$Lf\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]]}]]}]]],\"m\":\"$undefined\",\"G\":[\"$10\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"9:[\"$\",\"article\",null,{\"className\":\"max-w-7xl mx-auto px-8 my-12\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"w-full relative mb-8 text-6xl font-extrabold tracking-normal text-center title-font\",\"children\":[\"$\",\"span\",null,{\"className\":\"bg-clip-text text-transparent bg-gradient-to-b from-blue-600 to-blue-500\",\"children\":\"Sitecore JSS Next.js on Azure Static Web Apps\"}]}],[\"$\",\"div\",null,{\"className\":\"flex items-center justify-center mb-16\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-base font-medium text-gray-600 group-hover:text-gray-800\",\"children\":[\"$\",\"time\",null,{\"dateTime\":\"2022-10-26\",\"children\":\"October\\t26, 2022\"}]}]}],[\"$\",\"div\",null,{\"className\":\"prose lg:prose-xl max-w-none prose-pre:p-0\",\"children\":[[\"$\",\"p\",\"p-0\",{\"children\":[\"Azure \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://techcommunity.microsoft.com/t5/apps-on-azure-blog/extending-next-js-support-in-azure-static-web-apps/ba-p/3627975\",\"children\":\"announced a few weeks ago\"}],\" that they now also support the non-static features from Next.js (e.g. \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://nextjs.org/docs/basic-features/data-fetching/incremental-static-regeneration\",\"children\":\"Incremental Static Regeneration\"}],\" \u0026 \",[\"$\",\"a\",\"a-2\",{\"href\":\"https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props\",\"children\":\"Server Side Rendering\"}],\") on Azure Static Web Apps(SWA).\"]}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":[\"Although I've already had a way of \",[\"$\",\"a\",\"a-0\",{\"href\":\"/sitecore-nextjs-without-vercel\",\"children\":\"hosting JSS Next.js\"}],\" on Azure. I was curious to see if I was able to deploy JSS Next.js using \",[\"$\",\"strong\",\"strong-0\",{\"children\":\"Azure SWA\"}],\" (I use \",[\"$\",\"strong\",\"strong-1\",{\"children\":\"SWA\"}],\" as abbreviation for Static Web App from here).\"]}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":\"Of course nothing is easy, so let's run through the problems I've had.\"}],\"\\n\",[\"$\",\"h2\",\"h2-0\",{\"children\":\"Problem 1, getting it deployed\"}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"children\":[\"I created a new Sitecore JSS project using the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://doc.sitecore.com/xp/en/developers/hd/190/sitecore-headless-development/walkthrough--creating-a-jss-next-js-application-with-the-jss-cli.html\",\"children\":\"JSS CLI\"}],\". After that I followed the steps to \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://learn.microsoft.com/en-us/azure/static-web-apps/deploy-nextjs-hybrid\",\"children\":\"deploy a hybrid Next.js\"}],\" website to Azure. This connects to your GitHub repo and automatically creates a GitHub action. There I got the first problem:\"]}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":[[\"$\",\"code\",\"code-0\",{\"children\":\"SystemError [ERR_SYSTEM_ERROR]: A system error occurred: uv_os_get_passwd returned ENOENT (no such file or directory)\"}],\".\"]}],\"\\n\",[\"$\",\"p\",\"p-5\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"/blog/action-error.png\",\"alt\":\"GitHub action error\"}]}],\"\\n\",[\"$\",\"p\",\"p-6\",{\"children\":[\"So the \",[\"$\",\"code\",\"code-0\",{\"children\":\"username-sync\"}],\" package is the culprit, this is a dependency from the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://www.npmjs.com/package/sync-disk-cache\",\"children\":\"sync-disk-cache\"}],\" npm package. Sitecore JSS is using this npm package to solve the \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://nextjs.org/docs/advanced-features/preview-mode#previewdata-size-limits\",\"children\":\"2kb preview data problem\"}],\".\"]}],\"\\n\",[\"$\",\"p\",\"p-7\",{\"children\":[\"So apparently the \",[\"$\",\"code\",\"code-0\",{\"children\":\"username-sync\"}],\" package doesn't play nicely on GitHub actions. I worked around it by \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/erwinsmit/swa-jss/tree/master/username-sync\",\"children\":\"overwriting this package\"}],\" with a hardcoded value.\"]}],\"\\n\",[\"$\",\"p\",\"p-8\",{\"children\":[\"Before the \",[\"$\",\"code\",\"code-0\",{\"children\":\"next:build\"}],\" I copied the patch into the node_modules directory overwriting the original npm package.\"]}],\"\\n\",[\"$\",\"pre\",\"pre-0\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-json\",\"children\":[\"package.json\\n\",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-attr\",\"children\":\"\\\"build\\\"\"}],[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-string\",\"children\":\"\\\"ncp username-sync node_modules/username-sync \u0026\u0026 npm-run-all --serial bootstrap next:build\\\"\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-9\",{\"children\":\"And it worked! We now have a nice fast frontend with a fast simple pipeline. But then I went to the Experience Editor...\"}],\"\\n\",[\"$\",\"h2\",\"h2-1\",{\"children\":\"Problem 2, EditingDataDiskCache doesn't work\"}],\"\\n\",[\"$\",\"p\",\"p-10\",{\"children\":\"When hitting the Experience Editor I noticed the API routes were returning 500 errors, in Azure Application Insights I got the following errors:\"}],\"\\n\",[\"$\",\"p\",\"p-11\",{\"children\":[\"$\",\"code\",\"code-0\",{\"children\":\"Editing data cache miss for key 9f1a55c0-ad8b-51e4-8064-6e427bf80000-y3iv6vzpa3 at /tmp/if-you-need-to-delete-this-open-an-issue-sync-disk-cache/editing-data\"}]}],\"\\n\",[\"$\",\"p\",\"p-12\",{\"children\":[\"I know from \",[\"$\",\"a\",\"a-0\",{\"href\":\"/sitecore-jss-on-azure-functions/\",\"children\":\"experience\"}],\" that these errors are coming from the \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://github.com/Sitecore/jss/blob/dev/packages/sitecore-jss-nextjs/src/editing/editing-data-cache.ts\",\"children\":\"EditingDataDiskCache\"}],\". Apparently with Azure SWA you can't write and read stuff to the TMP directory. Also configuring a different TMP directory did not fix this problem.\"]}],\"\\n\",[\"$\",\"p\",\"p-13\",{\"children\":[\"So, I had to find a different way of saving the \",[\"$\",\"em\",\"em-0\",{\"children\":\"Preview data\"}],\" somewhere. In Azure this can be done cheap and easy with a Storage account resource. I created a Storage account, added a container to the Blob Storage and now I just had to find a way to read/write from there.\"]}],\"\\n\",[\"$\",\"p\",\"p-14\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"/blog/blob-storage.png\",\"alt\":\"Blob storage\"}]}],\"\\n\",[\"$\",\"p\",\"p-15\",{\"children\":[\"Luckily Azure has good \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://learn.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-nodejs?tabs=environment-variable-windows#upload-blobs-to-a-container\",\"children\":\"documentation\"}],\" on this and a \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://www.npmjs.com/package/@azure/storage-blob\",\"children\":\"NPM package\"}],\".\"]}],\"\\n\",[\"$\",\"p\",\"p-16\",{\"children\":\"With this package it's as easy as this to upload blobs.\"}],\"\\n\",[\"$\",\"pre\",\"pre-1\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-javascript\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-keyword\",\"children\":\"export\"}],\" \",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-keyword\",\"children\":\"class\"}],\" \",[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-title class_\",\"children\":\"EditingDataBlobCache\"}],\" implements \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-title class_\",\"children\":\"EditingDataCache\"}],\" {\\n  private \",[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-attr\",\"children\":\"containerClient\"}],\": \",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-title class_\",\"children\":\"ContainerClient\"}],\";\\n\\n  \",[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-title function_\",\"children\":\"constructor\"}],\"(\",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-params\"}],\") {\\n    \",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" blobServiceClient = \",[\"$\",\"span\",\"span-9\",{\"className\":\"hljs-title class_\",\"children\":\"BlobServiceClient\"}],\".\",[\"$\",\"span\",\"span-10\",{\"className\":\"hljs-title function_\",\"children\":\"fromConnectionString\"}],\"(\\n      process.\",[\"$\",\"span\",\"span-11\",{\"className\":\"hljs-property\",\"children\":\"env\"}],\".\",[\"$\",\"span\",\"span-12\",{\"className\":\"hljs-property\",\"children\":\"AZURE_STORAGE_CONNECTION_STRING\"}],\"\\n    );\\n\\n    \",[\"$\",\"span\",\"span-13\",{\"className\":\"hljs-variable language_\",\"children\":\"this\"}],\".\",[\"$\",\"span\",\"span-14\",{\"className\":\"hljs-property\",\"children\":\"containerClient\"}],\" = blobServiceClient.\",[\"$\",\"span\",\"span-15\",{\"className\":\"hljs-title function_\",\"children\":\"getContainerClient\"}],\"(process.\",[\"$\",\"span\",\"span-16\",{\"className\":\"hljs-property\",\"children\":\"env\"}],\".\",[\"$\",\"span\",\"span-17\",{\"className\":\"hljs-property\",\"children\":\"AZURE_BLOB_CONTAINER\"}],\");\\n  }\\n\\n  \",[\"$\",\"span\",\"span-18\",{\"className\":\"hljs-keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",\"span-19\",{\"className\":\"hljs-title function_\",\"children\":\"set\"}],\"(\",[\"$\",\"span\",\"span-20\",{\"className\":\"hljs-attr\",\"children\":\"key\"}],\": string, \",[\"$\",\"span\",\"span-21\",{\"className\":\"hljs-attr\",\"children\":\"editingData\"}],\": \",[\"$\",\"span\",\"span-22\",{\"className\":\"hljs-title class_\",\"children\":\"EditingData\"}],\"): \",[\"$\",\"span\",\"span-23\",{\"className\":\"hljs-title class_\",\"children\":\"Promise\"}],\"\u003c\",[\"$\",\"span\",\"span-24\",{\"className\":\"hljs-keyword\",\"children\":\"void\"}],\"\u003e {\\n    \",[\"$\",\"span\",\"span-25\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" blobName = key + \",[\"$\",\"span\",\"span-26\",{\"className\":\"hljs-string\",\"children\":\"'.txt'\"}],\";\\n    \",[\"$\",\"span\",\"span-27\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" blockBlobClient = \",[\"$\",\"span\",\"span-28\",{\"className\":\"hljs-variable language_\",\"children\":\"this\"}],\".\",[\"$\",\"span\",\"span-29\",{\"className\":\"hljs-property\",\"children\":\"containerClient\"}],\".\",[\"$\",\"span\",\"span-30\",{\"className\":\"hljs-title function_\",\"children\":\"getBlockBlobClient\"}],\"(blobName);\\n    \",[\"$\",\"span\",\"span-31\",{\"className\":\"hljs-comment\",\"children\":\"// Upload data to the blob\"}],\"\\n    \",[\"$\",\"span\",\"span-32\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" data = \",[\"$\",\"span\",\"span-33\",{\"className\":\"hljs-title class_\",\"children\":\"JSON\"}],\".\",[\"$\",\"span\",\"span-34\",{\"className\":\"hljs-title function_\",\"children\":\"stringify\"}],\"(editingData);\\n    \",[\"$\",\"span\",\"span-35\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" uploadBlobResponse = \",[\"$\",\"span\",\"span-36\",{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" blockBlobClient.\",[\"$\",\"span\",\"span-37\",{\"className\":\"hljs-title function_\",\"children\":\"upload\"}],\"(data, data.\",[\"$\",\"span\",\"span-38\",{\"className\":\"hljs-property\",\"children\":\"length\"}],\");\\n  }\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-17\",{\"children\":[\"All I had to do was create a custom \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/erwinsmit/swa-jss/blob/master/src/lib/editing/editing-data-cache.ts\",\"children\":\"EditingDataDiskCache\"}],\" implementation and plug that into the Sitecore JSS code. The plugging is well supported by the JSS codebase, the implementation can be passed as follows on the \",[\"$\",\"code\",\"code-0\",{\"children\":\"api/editing/data/[key].ts\"}],\" API route:\"]}],\"\\n\",[\"$\",\"pre\",\"pre-2\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-javascript\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-keyword\",\"children\":\"import\"}],\" { \",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-title class_\",\"children\":\"EditingDataDiskCache\"}],\" } \",[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-keyword\",\"children\":\"from\"}],\" \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-string\",\"children\":\"\\\"lib/editing/editing-data-cache\\\"\"}],\";\\n\",[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" handler = \",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-title class_\",\"children\":\"EditingDataMiddleware\"}],\"({ \",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-attr\",\"children\":\"editingDataCache\"}],\": editingDataCache }).\",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-title function_\",\"children\":\"getHandler\"}],\"();\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-18\",{\"children\":[\"So the architecture looks as illustrated below. This is an updated diagram from the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://doc.sitecore.com/xp/en/developers/hd/190/sitecore-headless-development/architecture-and-apis-for-integrating-jss-next-js-apps-with-sitecore-editors.html\",\"children\":\"Sitecore documentation\"}],\" where the regular disk cache is replaced with our own implementation.\"]}],\"\\n\",[\"$\",\"p\",\"p-19\",{\"children\":[\"$\",\"img\",\"img-0\",{\"src\":\"/blog/new-architecture.png\",\"alt\":\"New architecture\"}]}],\"\\n\",[\"$\",\"p\",\"p-20\",{\"children\":[\"And now it all works! So do I prefer using Azure SWA over my own custom \",[\"$\",\"a\",\"a-0\",{\"href\":\"/sitecore-nextjs-without-vercel\",\"children\":\"solution\"}],\"? I think I do, mainly for these reasons:\"]}],\"\\n\",[\"$\",\"ul\",\"ul-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":\"The API routes are automatically transformed into Azure Functions\"}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":\"Deploying is much easier, no large custom pipelines, just use the pipeline from Azure SWA, configure the environment variables and you're good to go!\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-21\",{\"children\":\"Sometimes you have to kill your babies. At least I've learned a lot about Next.js \u0026 JSS in the process!\"}],\"\\n\",[\"$\",\"p\",\"p-22\",{\"children\":[\"For the code, have a look at my \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://github.com/erwinsmit/swa-jss\",\"children\":\"repo\"}],\". The required customizations can be found in the folder \",[\"$\",\"a\",\"a-1\",{\"href\":\"https://github.com/erwinsmit/swa-jss/tree/master/src/lib/editing\",\"children\":\"src/lib/editing\"}],\".\"]}]]}]]}]\n"])</script><script>self.__next_f.push([1,"f:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Sitecore JSS Next.js on Azure Static Web Apps\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Erwin Smit - Freelance frontend developer / fullstack developer\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:title\",\"content\":\"Sitecore JSS Next.js on Azure Static Web Apps\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:description\",\"content\":\"Erwin Smit - Freelance frontend developer / fullstack developer\"}],[\"$\",\"meta\",\"5\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"6\",{\"name\":\"twitter:title\",\"content\":\"Sitecore JSS Next.js on Azure Static Web Apps\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:description\",\"content\":\"Erwin Smit - Freelance frontend developer / fullstack developer\"}]]\n"])</script><script>self.__next_f.push([1,"b:null\n"])</script></body></html>