4:"$Sreact.fragment"
5:I[7256,["231","static/chunks/231-015614b9a59ae6eb.js","173","static/chunks/173-e6c8bf506bfb93ff.js","185","static/chunks/app/layout-28f46ae9c6a8b2dc.js"],"default"]
6:I[9275,[],""]
7:I[1343,[],""]
8:I[4703,["231","static/chunks/231-015614b9a59ae6eb.js","160","static/chunks/app/not-found-081a5836cd82c2ca.js"],"default"]
a:I[3120,[],"OutletBoundary"]
c:I[3120,[],"MetadataBoundary"]
e:I[3120,[],"ViewportBoundary"]
10:I[6130,[],""]
1:HL["/_next/static/media/a34f9d1faa5f3315-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
2:HL["/_next/static/css/0f5f8cc0eb7d6afc.css","style"]
3:HL["/_next/static/css/3a398bc4ce4edcc7.css","style"]
0:{"P":null,"b":"qbAWKY8PVw4b-TN6TLmIA","p":"","c":["","blog","sitecore-jss-on-azure-functions"],"i":false,"f":[[["",{"children":["blog",{"children":[["slug","sitecore-jss-on-azure-functions","d"],{"children":["__PAGE__?{\"slug\":\"sitecore-jss-on-azure-functions\"}",{}]}]}]},"$undefined","$undefined",true],["",["$","$4","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/0f5f8cc0eb7d6afc.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","children":[["$","head",null,{"children":[["$","link",null,{"rel":"apple-touch-icon","sizes":"180x180","href":"/favicon/apple-touch-icon.png"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"32x32","href":"/favicon/favicon-32x32.png"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"16x16","href":"/favicon/favicon-16x16.png"}],["$","link",null,{"rel":"manifest","href":"/favicon/site.webmanifest"}],["$","link",null,{"rel":"mask-icon","href":"/favicon/safari-pinned-tab.svg","color":"#000000"}],["$","link",null,{"rel":"shortcut icon","href":"/favicon/favicon.ico"}],["$","meta",null,{"name":"msapplication-TileColor","content":"#000000"}],["$","meta",null,{"name":"msapplication-config","content":"/favicon/browserconfig.xml"}],["$","meta",null,{"name":"theme-color","content":"#000"}],["$","link",null,{"rel":"alternate","type":"application/rss+xml","href":"/feed.xml"}]]}],["$","body",null,{"className":"bg-gray-100 [object Object]","children":[["$","$L5",null,{}],["$","main",null,{"className":"min-h-screen","children":["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","$L8",null,{}],"notFoundStyles":[]}]}],["$","section",null,{"className":"bg-gray-800 text-white py-12","children":["$","div",null,{"className":"container mx-auto px-4 text-center","children":[["$","h2",null,{"className":"text-2xl font-bold mb-6","id":"connect","children":"Connect With Me"}],["$","div",null,{"className":"flex justify-center space-x-6","children":[["$","a",null,{"href":"https://github.com/erwinsmit","target":"_blank","rel":"noopener noreferrer","className":"hover:text-blue-400 transition-colors","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":32,"height":32,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-github","children":[["$","path","tonef",{"d":"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"}],["$","path","9comsn",{"d":"M9 18c-4.51 2-5-2-7-2"}],"$undefined"]}],["$","span",null,{"className":"sr-only","children":"GitHub"}]]}],["$","a",null,{"href":"https://www.linkedin.com/in/erwin-smit-40957840/","target":"_blank","rel":"noopener noreferrer","className":"hover:text-blue-400 transition-colors","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":32,"height":32,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-linkedin","children":[["$","path","c2jq9f",{"d":"M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"}],["$","rect","mk3on5",{"width":"4","height":"12","x":"2","y":"9"}],["$","circle","bt5ra8",{"cx":"4","cy":"4","r":"2"}],"$undefined"]}],["$","span",null,{"className":"sr-only","children":"LinkedIn"}]]}]]}]]}]}]]}]]}]]}],{"children":["blog",["$","$4","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]]}],{"children":[["slug","sitecore-jss-on-azure-functions","d"],["$","$4","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$0:f:0:1:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]]}],{"children":["__PAGE__",["$","$4","c",{"children":["$L9",[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/3a398bc4ce4edcc7.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$La",null,{"children":"$Lb"}]]}],{},null]},null]},null]},null],["$","$4","h",{"children":[null,["$","$4","-jSxWRaw8ZDK92KkX5dtr",{"children":[["$","$Lc",null,{"children":"$Ld"}],["$","$Le",null,{"children":"$Lf"}],["$","meta",null,{"name":"next-size-adjust"}]]}]]}]]],"m":"$undefined","G":["$10","$undefined"],"s":false,"S":true}
9:["$","article",null,{"className":"max-w-7xl mx-auto px-8 my-12","children":[["$","h1",null,{"className":"w-full relative mb-8 text-6xl font-extrabold tracking-normal text-center title-font","children":["$","span",null,{"className":"bg-clip-text text-transparent bg-gradient-to-b from-blue-600 to-blue-500","children":"Sitecore JSS on Azure Functions"}]}],["$","div",null,{"className":"flex items-center justify-center mb-16","children":["$","p",null,{"className":"text-base font-medium text-gray-600 group-hover:text-gray-800","children":["$","time",null,{"dateTime":"2021-10-27","children":"October\t27, 2021"}]}]}],["$","div",null,{"className":"prose lg:prose-xl max-w-none prose-pre:p-0","children":[["$","p","p-0",{"children":["As described in a previous post, we managed to host Next.js using a custom server in ",["$","a","a-0",{"href":"/blog/nextjs-on-azure-functions/","children":"Azure Functions"}],". Now let's see if this also works for Sitecore JSS."]}],"\n",["$","h2","h2-0",{"children":"Frontend only"}],"\n",["$","p","p-1",{"children":["For just the public facing part it was no problem, the exact same code as used in the custom server ",["$","a","a-0",{"href":"/blog/nextjs-on-azure-functions/","children":"previously"}]," worked fine.\nHowever to get the experience editor working we faced some challenges."]}],"\n",["$","h2","h2-1",{"children":"Experience editor"}],"\n",["$","p","p-2",{"children":["To get the Experience editor to work we have to do some more work. Mainly because the Next.js ",["$","a","a-0",{"href":"https://github.com/Sitecore/jss/tree/dev/samples/nextjs/src/pages/api/editing","children":"API routes"}]," are not supported when using a ",["$","a","a-1",{"href":"https://nextjs.org/docs/advanced-features/custom-server","children":"custom server"}],"."]}],"\n",["$","p","p-3",{"children":"Luckily these routes are easy to replicate using Azure Functions. So we created two Azure Functions that serves the:"}],"\n",["$","ul","ul-0",{"children":["\n",["$","li","li-0",{"children":"Editing Render Middleware"}],"\n",["$","li","li-1",{"children":"Editing Data Middleware"}],"\n"]}],"\n",["$","p","p-4",{"children":["Why do you need two endpoints for the Experience editor? This is to enable the ",["$","strong","strong-0",{"children":["$","a","a-0",{"href":"https://nextjs.org/docs/advanced-features/preview-mode","children":"Preview mode"}]}]," in Next.js. The preview mode bypasses all the clever stuff like ",["$","strong","strong-1",{"children":"ISG"}]," (Incremental Static Generation).\nHow these endpoints work together is explained well in the ",["$","a","a-0",{"href":"https://jss.sitecore.com/docs/nextjs/experience-editor/architecture","children":"JSS Docs"}],"."]}],"\n",["$","p","p-5",{"children":["Implementing these endpoints was done with the following code, this example is for the ",["$","a","a-0",{"href":"https://github.com/Sitecore/jss/blob/dev/packages/sitecore-jss-nextjs/src/middleware/editing-render-middleware.ts","children":"Editing Render Middleware"}],":"]}],"\n",["$","pre","pre-0",{"children":["$","code","code-0",{"className":"hljs language-javascript","children":[["$","span","span-0",{"className":"hljs-keyword","children":"import"}]," { ",["$","span","span-1",{"className":"hljs-title class_","children":"AzureFunction"}],", ",["$","span","span-2",{"className":"hljs-title class_","children":"Context"}],", ",["$","span","span-3",{"className":"hljs-title class_","children":"HttpRequest"}]," } ",["$","span","span-4",{"className":"hljs-keyword","children":"from"}]," ",["$","span","span-5",{"className":"hljs-string","children":"\"@azure/functions\""}],";\n",["$","span","span-6",{"className":"hljs-keyword","children":"import"}]," { ",["$","span","span-7",{"className":"hljs-title class_","children":"EditingRenderMiddleware"}]," } ",["$","span","span-8",{"className":"hljs-keyword","children":"from"}]," ",["$","span","span-9",{"className":"hljs-string","children":"\"@sitecore-jss/sitecore-jss-nextjs/middleware\""}],";\n\n",["$","span","span-10",{"className":"hljs-keyword","children":"const"}]," ",["$","span","span-11",{"className":"hljs-attr","children":"httpTrigger"}],": ",["$","span","span-12",{"className":"hljs-title class_","children":"AzureFunction"}]," = ",["$","span","span-13",{"className":"hljs-keyword","children":"async"}]," ",["$","span","span-14",{"className":"hljs-keyword","children":"function"}]," (",["$","span","span-15",{"className":"hljs-params","children":"context: Context, req: HttpRequest"}],"): ",["$","span","span-16",{"className":"hljs-title class_","children":"Promise"}],"<",["$","span","span-17",{"className":"hljs-keyword","children":"void"}],"> {\n  ",["$","span","span-18",{"className":"hljs-keyword","children":"const"}]," handler = ",["$","span","span-19",{"className":"hljs-keyword","children":"new"}]," ",["$","span","span-20",{"className":"hljs-title class_","children":"EditingRenderMiddleware"}],"().",["$","span","span-21",{"className":"hljs-title function_","children":"getHandler"}],"();\n\n  ",["$","span","span-22",{"className":"hljs-keyword","children":"try"}]," {\n    ",["$","span","span-23",{"className":"hljs-keyword","children":"await"}]," ",["$","span","span-24",{"className":"hljs-title function_","children":"handler"}],"(context.",["$","span","span-25",{"className":"hljs-property","children":"req"}],", context.",["$","span","span-26",{"className":"hljs-property","children":"res"}],");\n  } ",["$","span","span-27",{"className":"hljs-keyword","children":"catch"}]," (e) {\n    context.",["$","span","span-28",{"className":"hljs-title function_","children":"log"}],"(e);\n    context.",["$","span","span-29",{"className":"hljs-property","children":"res"}]," = {\n      ",["$","span","span-30",{"className":"hljs-attr","children":"status"}],": ",["$","span","span-31",{"className":"hljs-number","children":"500"}],",\n    };\n  }\n};\n\n",["$","span","span-32",{"className":"hljs-keyword","children":"export"}]," ",["$","span","span-33",{"className":"hljs-keyword","children":"default"}]," httpTrigger;\n"]}]}],"\n",["$","h3","h3-0",{"children":"Response handler"}],"\n",["$","p","p-6",{"children":["The problem is that the response from Azure does not contain the same methods as Vercel. An ",["$","a","a-0",{"href":"https://github.com/Sitecore/jss/blob/dev/packages/sitecore-jss-nextjs/src/middleware/editing-render-middleware.ts#L86","children":"example"}]," is seen here:"]}],"\n",["$","pre","pre-1",{"children":["$","code","code-0",{"className":"hljs language-javascript","children":[["$","span","span-0",{"className":"hljs-keyword","children":"return"}]," res.",["$","span","span-1",{"className":"hljs-title function_","children":"status"}],"(",["$","span","span-2",{"className":"hljs-number","children":"405"}],").",["$","span","span-3",{"className":"hljs-title function_","children":"json"}],"({\n  ",["$","span","span-4",{"className":"hljs-attr","children":"html"}],": ",["$","span","span-5",{"className":"hljs-string","children":["`<html><body>Invalid request method '",["$","span","span-0",{"className":"hljs-subst","children":"$${method}"}],"'</body></html>`"]}],",\n});\n"]}]}],"\n",["$","p","p-7",{"children":"Azure Functions will return errors that these methods don't exist. These methods are used throughout the Middlewares from Sitecore JSS. Do we need to replace all those middlewares? That would be a lot of work."}],"\n",["$","p","p-8",{"children":"The easiest fix was to create a function that transforms all the Vercel specific functions to a format Azure understands. So we created a Responsehandler function that accepts the Azure Function context and attaches the Vercel specific functions:"}],"\n",["$","pre","pre-2",{"children":["$","code","code-0",{"className":"hljs language-javascript","children":[["$","span","span-0",{"className":"hljs-keyword","children":"export"}]," ",["$","span","span-1",{"className":"hljs-keyword","children":"const"}]," ",["$","span","span-2",{"className":"hljs-title function_","children":"getNextResponseHandler"}]," = (",["$","span","span-3",{"className":"hljs-params","children":"context: Context"}],") => {\n\n    ",["$","span","span-4",{"className":"hljs-keyword","children":"const"}]," nextContextRes = context.",["$","span","span-5",{"className":"hljs-property","children":"res"}],";\n\n    nextContextRes.",["$","span","span-6",{"className":"hljs-property","children":"status"}]," = ",["$","span","span-7",{"className":"hljs-function","children":["(",["$","span","span-0",{"className":"hljs-params","children":"statusCode: number"}],") =>"]}]," {\n        nextContextRes.",["$","span","span-8",{"className":"hljs-property","children":"status"}]," = statusCode;\n\n        ",["$","span","span-9",{"className":"hljs-keyword","children":"return"}]," nextContextRes;\n    }\n\n    nextContextRes.",["$","span","span-10",{"className":"hljs-property","children":"setPreviewData"}]," = ",["$","span","span-11",{"className":"hljs-function","children":["(",["$","span","span-0",{"className":"hljs-params","children":"previewData: string"}],") =>"]}]," {\n        ",["$","span","span-12",{"className":"hljs-keyword","children":"const"}]," manifest = ",["$","span","span-13",{"className":"hljs-built_in","children":"require"}],"(",["$","span","span-14",{"className":"hljs-string","children":"'.next/prerender-manifest.json'"}],");\n\n        ",["$","span","span-15",{"className":"hljs-keyword","children":"const"}]," cookies = ",["$","span","span-16",{"className":"hljs-title function_","children":"setPreviewData"}],"(previewData, manifest.",["$","span","span-17",{"className":"hljs-property","children":"preview"}],");\n\n        nextContextRes.",["$","span","span-18",{"className":"hljs-property","children":"headers"}]," = {\n            ",["$","span","span-19",{"className":"hljs-string","children":"'Set-Cookie'"}],": cookies.",["$","span","span-20",{"className":"hljs-title function_","children":"join"}],"(",["$","span","span-21",{"className":"hljs-string","children":"';'"}],"),\n            ",["$","span","span-22",{"className":"hljs-string","children":"'Content-Type'"}],": ",["$","span","span-23",{"className":"hljs-string","children":"\"application/json; charset=utf-8\""}],"\n        };\n    };\n\netc etc...\n"]}]}],"\n",["$","p","p-9",{"children":"Now this method can be used within the Azure Function:"}],"\n",["$","pre","pre-3",{"children":["$","code","code-0",{"className":"hljs language-javascript","children":[["$","span","span-0",{"className":"hljs-keyword","children":"const"}]," nextResponseHandler = ",["$","span","span-1",{"className":"hljs-title function_","children":"getNextResponseHandler"}],"(context);\n\n    ",["$","span","span-2",{"className":"hljs-keyword","children":"try"}]," {\n        ",["$","span","span-3",{"className":"hljs-keyword","children":"await"}]," ",["$","span","span-4",{"className":"hljs-title function_","children":"handler"}],"(customContextReq, nextResponseHandler);\n\n"]}]}],"\n",["$","p","p-10",{"children":["Creating the ",["$","code","code-0",{"children":"setPreview"}]," method was a pain. Because the correct functions are not ",["$","a","a-0",{"href":"https://github.com/vercel/next.js/blob/5ddee4494bf1fbcfd91ce81bc59f8de66949c9fc/packages/next/server/api-utils.ts#L420","children":"exposed by Next.js"}],". For this reason I ended up doing quite a bit of copy-pasting from the Next.js repository to get it to work."]}],"\n",["$","h3","h3-1",{"children":"Editing data cache"}],"\n",["$","p","p-11",{"children":["Another issue we faced was the caching middleware throwing errors. After some digging the ",["$","a","a-0",{"href":"https://github.com/Sitecore/jss/blob/dev/packages/sitecore-jss-nextjs/src/middleware/editing-data-cache.ts#L24","children":"following line"}]," caused an issue:"]}],"\n",["$","pre","pre-4",{"children":["$","code","code-0",{"className":"hljs language-javascript","children":["  ",["$","span","span-0",{"className":"hljs-title function_","children":"constructor"}],"(",["$","span","span-1",{"className":"hljs-params"}],") {\n    ",["$","span","span-2",{"className":"hljs-comment","children":"// Use gzip compression and store using the OS temp directory (Vercel Serverless Functions have temp directory access)"}],"\n    ",["$","span","span-3",{"className":"hljs-variable language_","children":"this"}],".",["$","span","span-4",{"className":"hljs-property","children":"cache"}]," = ",["$","span","span-5",{"className":"hljs-keyword","children":"new"}]," ",["$","span","span-6",{"className":"hljs-title class_","children":"Cache"}],"(",["$","span","span-7",{"className":"hljs-string","children":"'editing-data'"}],", { ",["$","span","span-8",{"className":"hljs-attr","children":"compression"}],": ",["$","span","span-9",{"className":"hljs-string","children":"'gzip'"}],", ",["$","span","span-10",{"className":"hljs-attr","children":"location"}],": os.",["$","span","span-11",{"className":"hljs-title function_","children":"tmpdir"}],"() });\n  }\n"]}]}],"\n",["$","p","p-12",{"children":[["$","code","code-0",{"children":"os.tempdir()"}]," was pointing to a directory where a Consumption Based Azure Function was not allowed to read/write to."]}],"\n",["$","p","p-13",{"children":"To resolve this, we created a custom EditingDataCache middleware function that sets a different directory. That middleware is added as a parameter to the EditingDataMiddleWare:"}],"\n",["$","pre","pre-5",{"children":["$","code","code-0",{"className":"hljs language-javascript","children":[["$","span","span-0",{"className":"hljs-keyword","children":"const"}]," handler = ",["$","span","span-1",{"className":"hljs-keyword","children":"new"}]," ",["$","span","span-2",{"className":"hljs-title class_","children":"EditingDataMiddleware"}],"({\n  ",["$","span","span-3",{"className":"hljs-attr","children":"editingDataCache"}],": editingDataDiskCache,\n}).",["$","span","span-4",{"className":"hljs-title function_","children":"getHandler"}],"();\n"]}]}],"\n",["$","p","p-14",{"children":["It would be nice if this directory could be set as a parameter to the existing EditingDataDiskCache class. Hopefully, this ",["$","a","a-0",{"href":"https://github.com/Sitecore/jss/pull/839","children":"pull request"}]," will sort that out."]}],"\n",["$","h2","h2-2",{"children":"Tell Sitecore where to look for the Azure Function"}],"\n",["$","p","p-15",{"children":"Finally tell sitecore where to look for the Azure Function. This can be done in the config files of the Sitecore instance."}],"\n",["$","pre","pre-6",{"children":["$","code","code-0",{"className":"hljs language-xml","children":[["$","span","span-0",{"className":"hljs-tag","children":["<",["$","span","span-0",{"className":"hljs-name","children":"app"}]," ",["$","span","span-1",{"className":"hljs-attr","children":"name"}],"=",["$","span","span-2",{"className":"hljs-string","children":"\"jss-nextjs-app\""}],"\n    ",["$","span","span-3",{"className":"hljs-attr","children":"..."}],"\n    ",["$","span","span-4",{"className":"hljs-attr","children":"serverSideRenderingEngineEndpointUrl"}],"=",["$","span","span-5",{"className":"hljs-string","children":"\"https://${yourfunctionapp}.azurewebsites.net/api/editing/render\""}],"\n    ",["$","span","span-6",{"className":"hljs-attr","children":"serverSideRenderingEngineApplicationUrl"}],"=",["$","span","span-7",{"className":"hljs-string","children":"\"https://${yourfunctionapp}.azurewebsites.net/\""}],"\n/>"]}],"\n"]}]}],"\n",["$","p","p-16",{"children":"That's it, those were the problems we faced. Hopefully this could be helpful for anyone else facing similar issues."}]]}]]}]
f:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
d:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Sitecore JSS on Azure Functions"}],["$","meta","2",{"name":"description","content":"Erwin Smit - Freelance frontend developer / fullstack developer"}],["$","meta","3",{"property":"og:title","content":"Sitecore JSS on Azure Functions"}],["$","meta","4",{"property":"og:description","content":"Erwin Smit - Freelance frontend developer / fullstack developer"}],["$","meta","5",{"name":"twitter:card","content":"summary"}],["$","meta","6",{"name":"twitter:title","content":"Sitecore JSS on Azure Functions"}],["$","meta","7",{"name":"twitter:description","content":"Erwin Smit - Freelance frontend developer / fullstack developer"}]]
b:null
