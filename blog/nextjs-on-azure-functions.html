<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/a34f9d1faa5f3315-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/87cbc7cac530fcf5.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/3a398bc4ce4edcc7.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-8af1d2e0ff41d756.js"/><script src="/_next/static/chunks/4bd1b696-05ac3765304a89c0.js" async=""></script><script src="/_next/static/chunks/215-c1a7d2d931604563.js" async=""></script><script src="/_next/static/chunks/main-app-e5edefe120089e16.js" async=""></script><script src="/_next/static/chunks/231-015614b9a59ae6eb.js" async=""></script><script src="/_next/static/chunks/173-e6c8bf506bfb93ff.js" async=""></script><script src="/_next/static/chunks/app/layout-28f46ae9c6a8b2dc.js" async=""></script><script src="/_next/static/chunks/app/not-found-081a5836cd82c2ca.js" async=""></script><meta name="next-size-adjust"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><title>Next.js on Azure Functions</title><meta name="description" content="Erwin Smit - Freelance frontend developer / fullstack developer"/><meta property="og:title" content="Next.js on Azure Functions"/><meta property="og:description" content="Erwin Smit - Freelance frontend developer / fullstack developer"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Next.js on Azure Functions"/><meta name="twitter:description" content="Erwin Smit - Freelance frontend developer / fullstack developer"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="bg-gray-100 [object Object]"><header class="bg-blue-600 text-white shadow-md"><div class="container mx-auto px-4 py-4"><div class="flex justify-between items-center"><a href="/"><div class="flex items-center space-x-4 bg-blue-700 rounded-full py-2 px-4"><img alt="Erwin Smit" loading="lazy" width="40" height="40" decoding="async" data-nimg="1" class="rounded-full border-2 border-white" style="color:transparent;height:40px;width:40px;object-fit:cover" src="/assets/selfie2.jpg"/><span class="font-semibold text-lg text-white">Erwin Smit</span></div></a><nav class="flex-grow"><ul class="flex justify-end space-x-6"><li><a class="hover:text-blue-200 transition duration-150 ease-in-out" href="/">About me</a></li><li><a class="hover:text-blue-200 transition duration-150 ease-in-out" href="/blog">Blog</a></li></ul></nav></div></div></header><main class="min-h-screen"><article class="max-w-7xl mx-auto px-8 my-12"><h1 class="w-full relative mb-8 text-6xl font-extrabold tracking-normal text-center title-font"><span class="bg-clip-text text-transparent bg-gradient-to-b from-blue-600 to-blue-500">Next.js on Azure Functions</span></h1><div class="flex items-center justify-center mb-16"><p class="text-base font-medium text-gray-600 group-hover:text-gray-800"><time dateTime="2021-10-13">October	13, 2021</time></p></div><div class="prose lg:prose-xl max-w-none prose-pre:p-0"><p>Next.js is a great framework for creating react applications. I was always a fan of <strong>SSG (Static Site Generation)</strong> using for example Gatsby (this blog is using Gatsby too).
Websites using <strong>SSG</strong> have low hosting costs. No computing power is needed for rendering stuff to the end-user. With the great tooling available it still feels dynamic, you can still use a CMS, you just need to run a new build when some content has changed.</p>
<p>This is all great but when you make content changes all the time it is not that scalable. Sometimes you also still need SSR (Server Side Rendering). With Next.js you can have both at the same time! For me the key advantages of Next.js are:</p>
<ul>
<li><strong>SSG</strong> (Build pages as static assets on build-time)</li>
<li><strong>SSR</strong> (Serve pages server-side rendered on request)</li>
<li><strong>ISG</strong> (Incremental Static Generation)</li>
</ul>
<p><strong>ISG</strong> is a great feature, a page that is statically rendered using SSG can still update on request when the <a href="https://nextjs.org/docs/basic-features/data-fetching"><em>revalidate</em></a> time on a page has expired. A real-life scenario would be:</p>
<ol>
<li>User 1 requests the &quot;/contact&quot; page where revalidate is set to 10 (seconds). The page is not generated on build time so a static asset is created on the server containing the HTML.</li>
<li>User 2 enters the contact page a few seconds later, it will receive the statically generated HTML triggered by event <strong>1</strong> above.</li>
<li>User 1 refreshes the page 10 seconds later, the page will update itself and will be served as a static asset to the next user that enters the page within 10 seconds.</li>
</ol>
<p>With the use case described above, you wonder why you would ever need SSR. I&#x27;m also not sure when you still need it, you could say it&#x27;s necessary when the content is unique per visitor (price information for example).
But if that&#x27;s the case, you could also fetch the data using client-side calls, unique content specifically for a user should not be important for SEO.</p>
<p>At Macaw we build a lot of stuff with Sitecore so I&#x27;m excited to see Sitecore JSS supports Next.js out of the box! However, there are some challenges...</p>
<h2>Hosting Next.js without Vercel</h2>
<p>Next.js recommends you host your Next.js application on Vercel, this makes perfect sense because Vercel is the company behind Next.js. In Vercel you simply link your Next.js Github repository, click next a few times and you have a Next.js site up and running!</p>
<p>Most of our clients already pay for an Azure subscription, so it doesn&#x27;t always make sense for the clients to also pay for Vercel. This makes their IT landscape less consistent.</p>
<p>Also the pricing is hard to calculate. For a developer creating a hobby website, it&#x27;s free which is great. For a bit more bandwidth you pay $20 per member (I assume developer team member). Anything above that is a big mystery because you will fall into the Enterprise bracket. I heard some mixed <a href="https://www.reddit.com/r/nextjs/comments/ikr8jv/understanding_optimizing_nextjs_usage_on_vercel/">experiences</a> about that.</p>
<p>In other projects, we learned that you get the most bang for buck performance hosting your application in (consumption-based) Azure Functions. You only pay for the number of requests you get and it can scale up to infinity.</p>
<p>So how do you run Next.js on an Azure function? We decided to figure this out first with a basic Next.js website before diving into the Sitecore JSS implementation.</p>
<h2>Next.js custom server within an Azure Function</h2>
<p>Our project is set up with Lerna using the following folder structure:</p>
<ul>
<li><code>packages/nextjs-app</code></li>
<li><code>packages/nextjs-azure-functions</code></li>
</ul>
<p>Within the <code>nextjs-app</code> package we have an app generated by default using the Next.JS CLI. For demonstration purposes, we have a page that&#x27;s generated using <code>getServerSideProps</code> for SSR and a page using <code>getStaticProps</code> for SSG.</p>
<p>In the <code>nextjs-azure-functions</code> we have created a function for the custom server. The custom server is based on the examples provided by Next.js and placed in the context of an Azure Function. A custom server is required because you can&#x27;t just run <code>next start</code> within an Azure Function.</p>
<pre><code class="hljs language-javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">context: Context, req: HttpRequest</span>) {
    <span class="hljs-keyword">if</span> (!app) {
        app = <span class="hljs-title function_">next</span>({ 
            <span class="hljs-attr">dev</span>: <span class="hljs-literal">false</span>        
        });

        <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">prepare</span>();
        handle = app.<span class="hljs-title function_">getRequestHandler</span>();
    }

    <span class="hljs-keyword">const</span> path = (req?.<span class="hljs-property">params</span>?.<span class="hljs-property">remainingPath</span> &amp;&amp; req?.<span class="hljs-property">params</span>?.<span class="hljs-property">remainingPath</span> !== <span class="hljs-string">&quot;nextjsserver&quot;</span>) ? <span class="hljs-string">`/<span class="hljs-subst">${req?.params?.remainingPath}</span>`</span> : <span class="hljs-string">&quot;/index&quot;</span>
    
    <span class="hljs-keyword">const</span> protocol = req.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;https&quot;</span>) ? <span class="hljs-string">&quot;https://&quot;</span> : <span class="hljs-string">&quot;http://&quot;</span>;
    <span class="hljs-keyword">const</span> parsedUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">`<span class="hljs-subst">${path}</span>`</span>, <span class="hljs-string">`<span class="hljs-subst">${protocol}</span><span class="hljs-subst">${process.env.WEBSITE_HOSTNAME}</span>`</span>);

    <span class="hljs-comment">// This fixes the &quot;__nextlocale of undefined&quot; error</span>
    parsedUrl.<span class="hljs-property">search</span> = {};

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">handle</span>(req <span class="hljs-keyword">as</span> unknown <span class="hljs-keyword">as</span> <span class="hljs-title class_">IncomingMessage</span>, context.<span class="hljs-property">res</span> <span class="hljs-keyword">as</span> unknown <span class="hljs-keyword">as</span> <span class="hljs-title class_">ServerResponse</span>, parsedUrl);
    } <span class="hljs-keyword">catch</span>(e) {
        context.<span class="hljs-property">res</span> = {
            <span class="hljs-attr">status</span>: <span class="hljs-number">500</span>,
            <span class="hljs-attr">body</span>: path + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e)
        };
    }
}
</code></pre>
<p>The main challenge here was to add support for the routing, this is solved using the <code>remainingPath</code> parameter. This parameter is passed to the Azure Function using the <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-proxies">proxies.json</a></p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;$schema&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://json.schemastore.org/proxies&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;proxies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;rootpaths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;disabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;matchCondition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;methods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-string">&quot;GET&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;OPTIONS&quot;</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;route&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;{*remainingPath}&quot;</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;backendUri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://localhost/nextjsserver/{remainingPath}&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>    
</code></pre>
<p>Using this proxy the subpath after the baseurl is passed as a parameter. So when <a href="https://nextjsapp.com/category/tv">https://nextjsapp.com/category/tv</a> is requested <code>category/tv</code> will be the parameter passed to the Azure Function. Great, this works!</p>
<p>But... The static assets from Next.js are not showing up. E.g. when <code>_next/static/css/0c24874fa9ebf63f8a34.css</code> is requested, it will try to render a route within Next.js instead of serving the static file.</p>
<h2>Resolving static assets</h2>
<p>Also, this challenge can be solved with proxies:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;$schema&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://json.schemastore.org/proxies&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;proxies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    ...
    <span class="hljs-attr">&quot;staticFiles&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;disabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;matchCondition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;methods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-string">&quot;GET&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;OPTIONS&quot;</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;route&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_next/static/{*path}&quot;</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;backendUri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://localhost/serveStaticFile?path={path}&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<p>With this configuration, we catch all the requests that start with <code>next/static</code> and catch everything after that in a parameter called path. This parameter is passed to an azure function called <code>serveStaticFile</code> which looks like this:</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span>, <span class="hljs-title class_">HttpRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@azure/functions&quot;</span>;

<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>).<span class="hljs-property">promises</span>;
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;path&quot;</span>);

<span class="hljs-keyword">const</span> nextPath = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;../../basic-nextjs-example/.next/BUILD_ID&quot;</span>));

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">context: Context, req: HttpRequest</span>) {
    <span class="hljs-keyword">const</span> staticFilePath = req?.<span class="hljs-property">query</span>?.<span class="hljs-property">path</span>;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(path.<span class="hljs-title function_">join</span>(nextPath, <span class="hljs-string">&quot;static&quot;</span>, staticFilePath));

        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">body</span>: data
        }

    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">body</span>: <span class="hljs-string">`File not found <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(req.query)}</span>`</span>
        }
    }
}
</code></pre>
<p>This example could be more sophisticated with the inclusion of the Content-Type header. But the modern browsers seem to handle this fine.</p>
<h2>Choosing the right CDN</h2>
<p>While picking the CDN for your Azure Function it&#x27;s important to pick one that supports this Response Header correctly:</p>
<p><code>cache-control: s-maxage=10,stale-while-revalidate</code></p>
<p>You want the s-maxage value to be the same value as configured for <code>revalidate</code> in <code>getStaticProps</code></p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// static site generation...</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticProps</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://baconipsum.com/api/?type=meat-and-filler&#x27;</span>)
    <span class="hljs-keyword">const</span> meats = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
    <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">props</span>: {
            meats,
            <span class="hljs-attr">date</span>: <span class="hljs-string">`<span class="hljs-subst">${now.toLocaleDateString()}</span> - <span class="hljs-subst">${now.toLocaleTimeString()}</span>`</span>
        },
        <span class="hljs-attr">revalidate</span>: <span class="hljs-number">10</span>
    }
}
</code></pre>
<p>Not all <a href="https://docs.microsoft.com/en-us/azure/cdn/cdn-features">CDN&#x27;s</a> in Azure support this. Only <code>Standard Microsoft</code> and <code>Premium Verizon</code> support this feature currently.</p>
<h2>What&#x27;s next?</h2>
<p>This is my first post about my investigation on Next.js on azure and Sitecore JSS. Coming up are posts about:</p>
<ul>
<li>Deploying Azure Functions using Github actions</li>
<li>Sitecore JSS on azure functions</li>
<li>Creating components in Sitecore JSS</li>
<li>Integrate Sitecore OrderCloud and other services in Sitecore JSS</li>
</ul></div></article></main><section class="bg-gray-800 text-white py-12"><div class="container mx-auto px-4 text-center"><h2 class="text-2xl font-bold mb-6" id="connect">Connect With Me</h2><div class="flex justify-center space-x-6"><a href="https://github.com/erwinsmit" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg><span class="sr-only">GitHub</span></a><a href="https://www.linkedin.com/in/erwin-smit-40957840/" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg><span class="sr-only">LinkedIn</span></a></div></div></section><script src="/_next/static/chunks/webpack-8af1d2e0ff41d756.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"4:\"$Sreact.fragment\"\n5:I[7256,[\"231\",\"static/chunks/231-015614b9a59ae6eb.js\",\"173\",\"static/chunks/173-e6c8bf506bfb93ff.js\",\"185\",\"static/chunks/app/layout-28f46ae9c6a8b2dc.js\"],\"default\"]\n6:I[9275,[],\"\"]\n7:I[1343,[],\"\"]\n8:I[4703,[\"231\",\"static/chunks/231-015614b9a59ae6eb.js\",\"160\",\"static/chunks/app/not-found-081a5836cd82c2ca.js\"],\"default\"]\na:I[3120,[],\"OutletBoundary\"]\nc:I[3120,[],\"MetadataBoundary\"]\ne:I[3120,[],\"ViewportBoundary\"]\n10:I[6130,[],\"\"]\n1:HL[\"/_next/static/media/a34f9d1faa5f3315-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/87cbc7cac530fcf5.css\",\"style\"]\n3:HL[\"/_next/static/css/3a398bc4ce4edcc7.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"jO72GCnrgd_g1z0vOogJG\",\"p\":\"\",\"c\":[\"\",\"blog\",\"nextjs-on-azure-functions\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"nextjs-on-azure-functions\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"nextjs-on-azure-functions\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$4\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/87cbc7cac530fcf5.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"apple-touch-icon\",\"sizes\":\"180x180\",\"href\":\"/favicon/apple-touch-icon.png\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"sizes\":\"32x32\",\"href\":\"/favicon/favicon-32x32.png\"}],[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"sizes\":\"16x16\",\"href\":\"/favicon/favicon-16x16.png\"}],[\"$\",\"link\",null,{\"rel\":\"manifest\",\"href\":\"/favicon/site.webmanifest\"}],[\"$\",\"link\",null,{\"rel\":\"mask-icon\",\"href\":\"/favicon/safari-pinned-tab.svg\",\"color\":\"#000000\"}],[\"$\",\"link\",null,{\"rel\":\"shortcut icon\",\"href\":\"/favicon/favicon.ico\"}],[\"$\",\"meta\",null,{\"name\":\"msapplication-TileColor\",\"content\":\"#000000\"}],[\"$\",\"meta\",null,{\"name\":\"msapplication-config\",\"content\":\"/favicon/browserconfig.xml\"}],[\"$\",\"meta\",null,{\"name\":\"theme-color\",\"content\":\"#000\"}],[\"$\",\"link\",null,{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"/feed.xml\"}]]}],[\"$\",\"body\",null,{\"className\":\"bg-gray-100 [object Object]\",\"children\":[[\"$\",\"$L5\",null,{}],[\"$\",\"main\",null,{\"className\":\"min-h-screen\",\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"$L8\",null,{}],\"notFoundStyles\":[]}]}],[\"$\",\"section\",null,{\"className\":\"bg-gray-800 text-white py-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"container mx-auto px-4 text-center\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"text-2xl font-bold mb-6\",\"id\":\"connect\",\"children\":\"Connect With Me\"}],[\"$\",\"div\",null,{\"className\":\"flex justify-center space-x-6\",\"children\":[[\"$\",\"a\",null,{\"href\":\"https://github.com/erwinsmit\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"className\":\"hover:text-blue-400 transition-colors\",\"children\":[[\"$\",\"svg\",null,{\"ref\":\"$undefined\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":32,\"height\":32,\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":2,\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"lucide lucide-github\",\"children\":[[\"$\",\"path\",\"tonef\",{\"d\":\"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4\"}],[\"$\",\"path\",\"9comsn\",{\"d\":\"M9 18c-4.51 2-5-2-7-2\"}],\"$undefined\"]}],[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"GitHub\"}]]}],[\"$\",\"a\",null,{\"href\":\"https://www.linkedin.com/in/erwin-smit-40957840/\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"className\":\"hover:text-blue-400 transition-colors\",\"children\":[[\"$\",\"svg\",null,{\"ref\":\"$undefined\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":32,\"height\":32,\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":2,\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"className\":\"lucide lucide-linkedin\",\"children\":[[\"$\",\"path\",\"c2jq9f\",{\"d\":\"M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z\"}],[\"$\",\"rect\",\"mk3on5\",{\"width\":\"4\",\"height\":\"12\",\"x\":\"2\",\"y\":\"9\"}],[\"$\",\"circle\",\"bt5ra8\",{\"cx\":\"4\",\"cy\":\"4\",\"r\":\"2\"}],\"$undefined\"]}],[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"LinkedIn\"}]]}]]}]]}]}]]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$4\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"nextjs-on-azure-functions\",\"d\"],[\"$\",\"$4\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$4\",\"c\",{\"children\":[\"$L9\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/3a398bc4ce4edcc7.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$La\",null,{\"children\":\"$Lb\"}]]}],{},null]},null]},null]},null],[\"$\",\"$4\",\"h\",{\"children\":[null,[\"$\",\"$4\",\"6UVqe03rn5udZNNAwv1g0\",{\"children\":[[\"$\",\"$Lc\",null,{\"children\":\"$Ld\"}],[\"$\",\"$Le\",null,{\"children\":\"$Lf\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]]}]]}]]],\"m\":\"$undefined\",\"G\":[\"$10\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"9:[\"$\",\"article\",null,{\"className\":\"max-w-7xl mx-auto px-8 my-12\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"w-full relative mb-8 text-6xl font-extrabold tracking-normal text-center title-font\",\"children\":[\"$\",\"span\",null,{\"className\":\"bg-clip-text text-transparent bg-gradient-to-b from-blue-600 to-blue-500\",\"children\":\"Next.js on Azure Functions\"}]}],[\"$\",\"div\",null,{\"className\":\"flex items-center justify-center mb-16\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-base font-medium text-gray-600 group-hover:text-gray-800\",\"children\":[\"$\",\"time\",null,{\"dateTime\":\"2021-10-13\",\"children\":\"October\\t13, 2021\"}]}]}],[\"$\",\"div\",null,{\"className\":\"prose lg:prose-xl max-w-none prose-pre:p-0\",\"children\":[[\"$\",\"p\",\"p-0\",{\"children\":[\"Next.js is a great framework for creating react applications. I was always a fan of \",[\"$\",\"strong\",\"strong-0\",{\"children\":\"SSG (Static Site Generation)\"}],\" using for example Gatsby (this blog is using Gatsby too).\\nWebsites using \",[\"$\",\"strong\",\"strong-1\",{\"children\":\"SSG\"}],\" have low hosting costs. No computing power is needed for rendering stuff to the end-user. With the great tooling available it still feels dynamic, you can still use a CMS, you just need to run a new build when some content has changed.\"]}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":\"This is all great but when you make content changes all the time it is not that scalable. Sometimes you also still need SSR (Server Side Rendering). With Next.js you can have both at the same time! For me the key advantages of Next.js are:\"}],\"\\n\",[\"$\",\"ul\",\"ul-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"SSG\"}],\" (Build pages as static assets on build-time)\"]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"SSR\"}],\" (Serve pages server-side rendered on request)\"]}],\"\\n\",[\"$\",\"li\",\"li-2\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"ISG\"}],\" (Incremental Static Generation)\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"ISG\"}],\" is a great feature, a page that is statically rendered using SSG can still update on request when the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://nextjs.org/docs/basic-features/data-fetching\",\"children\":[\"$\",\"em\",\"em-0\",{\"children\":\"revalidate\"}]}],\" time on a page has expired. A real-life scenario would be:\"]}],\"\\n\",[\"$\",\"ol\",\"ol-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":\"User 1 requests the \\\"/contact\\\" page where revalidate is set to 10 (seconds). The page is not generated on build time so a static asset is created on the server containing the HTML.\"}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[\"User 2 enters the contact page a few seconds later, it will receive the statically generated HTML triggered by event \",[\"$\",\"strong\",\"strong-0\",{\"children\":\"1\"}],\" above.\"]}],\"\\n\",[\"$\",\"li\",\"li-2\",{\"children\":\"User 1 refreshes the page 10 seconds later, the page will update itself and will be served as a static asset to the next user that enters the page within 10 seconds.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"children\":\"With the use case described above, you wonder why you would ever need SSR. I'm also not sure when you still need it, you could say it's necessary when the content is unique per visitor (price information for example).\\nBut if that's the case, you could also fetch the data using client-side calls, unique content specifically for a user should not be important for SEO.\"}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":\"At Macaw we build a lot of stuff with Sitecore so I'm excited to see Sitecore JSS supports Next.js out of the box! However, there are some challenges...\"}],\"\\n\",[\"$\",\"h2\",\"h2-0\",{\"children\":\"Hosting Next.js without Vercel\"}],\"\\n\",[\"$\",\"p\",\"p-5\",{\"children\":\"Next.js recommends you host your Next.js application on Vercel, this makes perfect sense because Vercel is the company behind Next.js. In Vercel you simply link your Next.js Github repository, click next a few times and you have a Next.js site up and running!\"}],\"\\n\",[\"$\",\"p\",\"p-6\",{\"children\":\"Most of our clients already pay for an Azure subscription, so it doesn't always make sense for the clients to also pay for Vercel. This makes their IT landscape less consistent.\"}],\"\\n\",[\"$\",\"p\",\"p-7\",{\"children\":[\"Also the pricing is hard to calculate. For a developer creating a hobby website, it's free which is great. For a bit more bandwidth you pay $20 per member (I assume developer team member). Anything above that is a big mystery because you will fall into the Enterprise bracket. I heard some mixed \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://www.reddit.com/r/nextjs/comments/ikr8jv/understanding_optimizing_nextjs_usage_on_vercel/\",\"children\":\"experiences\"}],\" about that.\"]}],\"\\n\",[\"$\",\"p\",\"p-8\",{\"children\":\"In other projects, we learned that you get the most bang for buck performance hosting your application in (consumption-based) Azure Functions. You only pay for the number of requests you get and it can scale up to infinity.\"}],\"\\n\",[\"$\",\"p\",\"p-9\",{\"children\":\"So how do you run Next.js on an Azure function? We decided to figure this out first with a basic Next.js website before diving into the Sitecore JSS implementation.\"}],\"\\n\",[\"$\",\"h2\",\"h2-1\",{\"children\":\"Next.js custom server within an Azure Function\"}],\"\\n\",[\"$\",\"p\",\"p-10\",{\"children\":\"Our project is set up with Lerna using the following folder structure:\"}],\"\\n\",[\"$\",\"ul\",\"ul-1\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[\"$\",\"code\",\"code-0\",{\"children\":\"packages/nextjs-app\"}]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[\"$\",\"code\",\"code-0\",{\"children\":\"packages/nextjs-azure-functions\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-11\",{\"children\":[\"Within the \",[\"$\",\"code\",\"code-0\",{\"children\":\"nextjs-app\"}],\" package we have an app generated by default using the Next.JS CLI. For demonstration purposes, we have a page that's generated using \",[\"$\",\"code\",\"code-1\",{\"children\":\"getServerSideProps\"}],\" for SSR and a page using \",[\"$\",\"code\",\"code-2\",{\"children\":\"getStaticProps\"}],\" for SSG.\"]}],\"\\n\",[\"$\",\"p\",\"p-12\",{\"children\":[\"In the \",[\"$\",\"code\",\"code-0\",{\"children\":\"nextjs-azure-functions\"}],\" we have created a function for the custom server. The custom server is based on the examples provided by Next.js and placed in the context of an Azure Function. A custom server is required because you can't just run \",[\"$\",\"code\",\"code-1\",{\"children\":\"next start\"}],\" within an Azure Function.\"]}],\"\\n\",[\"$\",\"pre\",\"pre-0\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-javascript\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-variable language_\",\"children\":\"module\"}],\".\",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-property\",\"children\":\"exports\"}],\" = \",[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-keyword\",\"children\":\"function\"}],\" (\",[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-params\",\"children\":\"context: Context, req: HttpRequest\"}],\") {\\n    \",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-keyword\",\"children\":\"if\"}],\" (!app) {\\n        app = \",[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-title function_\",\"children\":\"next\"}],\"({ \\n            \",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-attr\",\"children\":\"dev\"}],\": \",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-literal\",\"children\":\"false\"}],\"        \\n        });\\n\\n        \",[\"$\",\"span\",\"span-9\",{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" app.\",[\"$\",\"span\",\"span-10\",{\"className\":\"hljs-title function_\",\"children\":\"prepare\"}],\"();\\n        handle = app.\",[\"$\",\"span\",\"span-11\",{\"className\":\"hljs-title function_\",\"children\":\"getRequestHandler\"}],\"();\\n    }\\n\\n    \",[\"$\",\"span\",\"span-12\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" path = (req?.\",[\"$\",\"span\",\"span-13\",{\"className\":\"hljs-property\",\"children\":\"params\"}],\"?.\",[\"$\",\"span\",\"span-14\",{\"className\":\"hljs-property\",\"children\":\"remainingPath\"}],\" \u0026\u0026 req?.\",[\"$\",\"span\",\"span-15\",{\"className\":\"hljs-property\",\"children\":\"params\"}],\"?.\",[\"$\",\"span\",\"span-16\",{\"className\":\"hljs-property\",\"children\":\"remainingPath\"}],\" !== \",[\"$\",\"span\",\"span-17\",{\"className\":\"hljs-string\",\"children\":\"\\\"nextjsserver\\\"\"}],\") ? \",[\"$\",\"span\",\"span-18\",{\"className\":\"hljs-string\",\"children\":[\"`/\",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-subst\",\"children\":\"$${req?.params?.remainingPath}\"}],\"`\"]}],\" : \",[\"$\",\"span\",\"span-19\",{\"className\":\"hljs-string\",\"children\":\"\\\"/index\\\"\"}],\"\\n    \\n    \",[\"$\",\"span\",\"span-20\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" protocol = req.\",[\"$\",\"span\",\"span-21\",{\"className\":\"hljs-property\",\"children\":\"url\"}],\".\",[\"$\",\"span\",\"span-22\",{\"className\":\"hljs-title function_\",\"children\":\"includes\"}],\"(\",[\"$\",\"span\",\"span-23\",{\"className\":\"hljs-string\",\"children\":\"\\\"https\\\"\"}],\") ? \",[\"$\",\"span\",\"span-24\",{\"className\":\"hljs-string\",\"children\":\"\\\"https://\\\"\"}],\" : \",[\"$\",\"span\",\"span-25\",{\"className\":\"hljs-string\",\"children\":\"\\\"http://\\\"\"}],\";\\n    \",[\"$\",\"span\",\"span-26\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" parsedUrl = \",[\"$\",\"span\",\"span-27\",{\"className\":\"hljs-keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",\"span-28\",{\"className\":\"hljs-title function_\",\"children\":\"URL\"}],\"(\",[\"$\",\"span\",\"span-29\",{\"className\":\"hljs-string\",\"children\":[\"`\",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-subst\",\"children\":\"$${path}\"}],\"`\"]}],\", \",[\"$\",\"span\",\"span-30\",{\"className\":\"hljs-string\",\"children\":[\"`\",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-subst\",\"children\":\"$${protocol}\"}],[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-subst\",\"children\":\"$${process.env.WEBSITE_HOSTNAME}\"}],\"`\"]}],\");\\n\\n    \",[\"$\",\"span\",\"span-31\",{\"className\":\"hljs-comment\",\"children\":\"// This fixes the \\\"__nextlocale of undefined\\\" error\"}],\"\\n    parsedUrl.\",[\"$\",\"span\",\"span-32\",{\"className\":\"hljs-property\",\"children\":\"search\"}],\" = {};\\n\\n    \",[\"$\",\"span\",\"span-33\",{\"className\":\"hljs-keyword\",\"children\":\"try\"}],\" {\\n        \",[\"$\",\"span\",\"span-34\",{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",\"span-35\",{\"className\":\"hljs-title function_\",\"children\":\"handle\"}],\"(req \",[\"$\",\"span\",\"span-36\",{\"className\":\"hljs-keyword\",\"children\":\"as\"}],\" unknown \",[\"$\",\"span\",\"span-37\",{\"className\":\"hljs-keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",\"span-38\",{\"className\":\"hljs-title class_\",\"children\":\"IncomingMessage\"}],\", context.\",[\"$\",\"span\",\"span-39\",{\"className\":\"hljs-property\",\"children\":\"res\"}],\" \",[\"$\",\"span\",\"span-40\",{\"className\":\"hljs-keyword\",\"children\":\"as\"}],\" unknown \",[\"$\",\"span\",\"span-41\",{\"className\":\"hljs-keyword\",\"children\":\"as\"}],\" \",[\"$\",\"span\",\"span-42\",{\"className\":\"hljs-title class_\",\"children\":\"ServerResponse\"}],\", parsedUrl);\\n    } \",[\"$\",\"span\",\"span-43\",{\"className\":\"hljs-keyword\",\"children\":\"catch\"}],\"(e) {\\n        context.\",[\"$\",\"span\",\"span-44\",{\"className\":\"hljs-property\",\"children\":\"res\"}],\" = {\\n            \",[\"$\",\"span\",\"span-45\",{\"className\":\"hljs-attr\",\"children\":\"status\"}],\": \",[\"$\",\"span\",\"span-46\",{\"className\":\"hljs-number\",\"children\":\"500\"}],\",\\n            \",[\"$\",\"span\",\"span-47\",{\"className\":\"hljs-attr\",\"children\":\"body\"}],\": path + \",[\"$\",\"span\",\"span-48\",{\"className\":\"hljs-title class_\",\"children\":\"JSON\"}],\".\",[\"$\",\"span\",\"span-49\",{\"className\":\"hljs-title function_\",\"children\":\"stringify\"}],\"(e)\\n        };\\n    }\\n}\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-13\",{\"children\":[\"The main challenge here was to add support for the routing, this is solved using the \",[\"$\",\"code\",\"code-0\",{\"children\":\"remainingPath\"}],\" parameter. This parameter is passed to the Azure Function using the \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-proxies\",\"children\":\"proxies.json\"}]]}],\"\\n\",[\"$\",\"pre\",\"pre-1\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-json\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n  \",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-attr\",\"children\":\"\\\"$schema\\\"\"}],[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-string\",\"children\":\"\\\"http://json.schemastore.org/proxies\\\"\"}],[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n  \",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-attr\",\"children\":\"\\\"proxies\\\"\"}],[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n    \",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-attr\",\"children\":\"\\\"rootpaths\\\"\"}],[\"$\",\"span\",\"span-9\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-10\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n      \",[\"$\",\"span\",\"span-11\",{\"className\":\"hljs-attr\",\"children\":\"\\\"disabled\\\"\"}],[\"$\",\"span\",\"span-12\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-13\",{\"className\":\"hljs-literal\",\"children\":[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-keyword\",\"children\":\"false\"}]}],[\"$\",\"span\",\"span-14\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n      \",[\"$\",\"span\",\"span-15\",{\"className\":\"hljs-attr\",\"children\":\"\\\"matchCondition\\\"\"}],[\"$\",\"span\",\"span-16\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-17\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n        \",[\"$\",\"span\",\"span-18\",{\"className\":\"hljs-attr\",\"children\":\"\\\"methods\\\"\"}],[\"$\",\"span\",\"span-19\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-20\",{\"className\":\"hljs-punctuation\",\"children\":\"[\"}],\" \",[\"$\",\"span\",\"span-21\",{\"className\":\"hljs-string\",\"children\":\"\\\"GET\\\"\"}],[\"$\",\"span\",\"span-22\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",\"span-23\",{\"className\":\"hljs-string\",\"children\":\"\\\"OPTIONS\\\"\"}],\" \",[\"$\",\"span\",\"span-24\",{\"className\":\"hljs-punctuation\",\"children\":\"]\"}],[\"$\",\"span\",\"span-25\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n        \",[\"$\",\"span\",\"span-26\",{\"className\":\"hljs-attr\",\"children\":\"\\\"route\\\"\"}],[\"$\",\"span\",\"span-27\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-28\",{\"className\":\"hljs-string\",\"children\":\"\\\"{*remainingPath}\\\"\"}],\"\\n      \",[\"$\",\"span\",\"span-29\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],[\"$\",\"span\",\"span-30\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n      \",[\"$\",\"span\",\"span-31\",{\"className\":\"hljs-attr\",\"children\":\"\\\"backendUri\\\"\"}],[\"$\",\"span\",\"span-32\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-33\",{\"className\":\"hljs-string\",\"children\":\"\\\"https://localhost/nextjsserver/{remainingPath}\\\"\"}],\"\\n    \",[\"$\",\"span\",\"span-34\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],\"\\n  \",[\"$\",\"span\",\"span-35\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],\"\\n\",[\"$\",\"span\",\"span-36\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],\"    \\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-14\",{\"children\":[\"Using this proxy the subpath after the baseurl is passed as a parameter. So when \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://nextjsapp.com/category/tv\",\"children\":\"https://nextjsapp.com/category/tv\"}],\" is requested \",[\"$\",\"code\",\"code-0\",{\"children\":\"category/tv\"}],\" will be the parameter passed to the Azure Function. Great, this works!\"]}],\"\\n\",[\"$\",\"p\",\"p-15\",{\"children\":[\"But... The static assets from Next.js are not showing up. E.g. when \",[\"$\",\"code\",\"code-0\",{\"children\":\"_next/static/css/0c24874fa9ebf63f8a34.css\"}],\" is requested, it will try to render a route within Next.js instead of serving the static file.\"]}],\"\\n\",[\"$\",\"h2\",\"h2-2\",{\"children\":\"Resolving static assets\"}],\"\\n\",[\"$\",\"p\",\"p-16\",{\"children\":\"Also, this challenge can be solved with proxies:\"}],\"\\n\",[\"$\",\"pre\",\"pre-2\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-json\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n  \",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-attr\",\"children\":\"\\\"$schema\\\"\"}],[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-string\",\"children\":\"\\\"http://json.schemastore.org/proxies\\\"\"}],[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n  \",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-attr\",\"children\":\"\\\"proxies\\\"\"}],[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n    ...\\n    \",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-attr\",\"children\":\"\\\"staticFiles\\\"\"}],[\"$\",\"span\",\"span-9\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-10\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n      \",[\"$\",\"span\",\"span-11\",{\"className\":\"hljs-attr\",\"children\":\"\\\"disabled\\\"\"}],[\"$\",\"span\",\"span-12\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-13\",{\"className\":\"hljs-literal\",\"children\":[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-keyword\",\"children\":\"false\"}]}],[\"$\",\"span\",\"span-14\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n      \",[\"$\",\"span\",\"span-15\",{\"className\":\"hljs-attr\",\"children\":\"\\\"matchCondition\\\"\"}],[\"$\",\"span\",\"span-16\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-17\",{\"className\":\"hljs-punctuation\",\"children\":\"{\"}],\"\\n        \",[\"$\",\"span\",\"span-18\",{\"className\":\"hljs-attr\",\"children\":\"\\\"methods\\\"\"}],[\"$\",\"span\",\"span-19\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-20\",{\"className\":\"hljs-punctuation\",\"children\":\"[\"}],\" \",[\"$\",\"span\",\"span-21\",{\"className\":\"hljs-string\",\"children\":\"\\\"GET\\\"\"}],[\"$\",\"span\",\"span-22\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",\"span-23\",{\"className\":\"hljs-string\",\"children\":\"\\\"OPTIONS\\\"\"}],\" \",[\"$\",\"span\",\"span-24\",{\"className\":\"hljs-punctuation\",\"children\":\"]\"}],[\"$\",\"span\",\"span-25\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n        \",[\"$\",\"span\",\"span-26\",{\"className\":\"hljs-attr\",\"children\":\"\\\"route\\\"\"}],[\"$\",\"span\",\"span-27\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-28\",{\"className\":\"hljs-string\",\"children\":\"\\\"_next/static/{*path}\\\"\"}],\"\\n      \",[\"$\",\"span\",\"span-29\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],[\"$\",\"span\",\"span-30\",{\"className\":\"hljs-punctuation\",\"children\":\",\"}],\"\\n      \",[\"$\",\"span\",\"span-31\",{\"className\":\"hljs-attr\",\"children\":\"\\\"backendUri\\\"\"}],[\"$\",\"span\",\"span-32\",{\"className\":\"hljs-punctuation\",\"children\":\":\"}],\" \",[\"$\",\"span\",\"span-33\",{\"className\":\"hljs-string\",\"children\":\"\\\"https://localhost/serveStaticFile?path={path}\\\"\"}],\"\\n    \",[\"$\",\"span\",\"span-34\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],\"\\n  \",[\"$\",\"span\",\"span-35\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],\"\\n\",[\"$\",\"span\",\"span-36\",{\"className\":\"hljs-punctuation\",\"children\":\"}\"}],\"\\n\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-17\",{\"children\":[\"With this configuration, we catch all the requests that start with \",[\"$\",\"code\",\"code-0\",{\"children\":\"next/static\"}],\" and catch everything after that in a parameter called path. This parameter is passed to an azure function called \",[\"$\",\"code\",\"code-1\",{\"children\":\"serveStaticFile\"}],\" which looks like this:\"]}],\"\\n\",[\"$\",\"pre\",\"pre-3\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-javascript\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-keyword\",\"children\":\"import\"}],\" { \",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-title class_\",\"children\":\"Context\"}],\", \",[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-title class_\",\"children\":\"HttpRequest\"}],\" } \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-keyword\",\"children\":\"from\"}],\" \",[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-string\",\"children\":\"\\\"@azure/functions\\\"\"}],\";\\n\\n\",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" fs = \",[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-built_in\",\"children\":\"require\"}],\"(\",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-string\",\"children\":\"'fs'\"}],\").\",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-property\",\"children\":\"promises\"}],\";\\n\",[\"$\",\"span\",\"span-9\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" path = \",[\"$\",\"span\",\"span-10\",{\"className\":\"hljs-built_in\",\"children\":\"require\"}],\"(\",[\"$\",\"span\",\"span-11\",{\"className\":\"hljs-string\",\"children\":\"\\\"path\\\"\"}],\");\\n\\n\",[\"$\",\"span\",\"span-12\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" nextPath = path.\",[\"$\",\"span\",\"span-13\",{\"className\":\"hljs-title function_\",\"children\":\"dirname\"}],\"(\",[\"$\",\"span\",\"span-14\",{\"className\":\"hljs-built_in\",\"children\":\"require\"}],\".\",[\"$\",\"span\",\"span-15\",{\"className\":\"hljs-title function_\",\"children\":\"resolve\"}],\"(\",[\"$\",\"span\",\"span-16\",{\"className\":\"hljs-string\",\"children\":\"\\\"../../basic-nextjs-example/.next/BUILD_ID\\\"\"}],\"));\\n\\n\",[\"$\",\"span\",\"span-17\",{\"className\":\"hljs-variable language_\",\"children\":\"module\"}],\".\",[\"$\",\"span\",\"span-18\",{\"className\":\"hljs-property\",\"children\":\"exports\"}],\" = \",[\"$\",\"span\",\"span-19\",{\"className\":\"hljs-keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",\"span-20\",{\"className\":\"hljs-keyword\",\"children\":\"function\"}],\" (\",[\"$\",\"span\",\"span-21\",{\"className\":\"hljs-params\",\"children\":\"context: Context, req: HttpRequest\"}],\") {\\n    \",[\"$\",\"span\",\"span-22\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" staticFilePath = req?.\",[\"$\",\"span\",\"span-23\",{\"className\":\"hljs-property\",\"children\":\"query\"}],\"?.\",[\"$\",\"span\",\"span-24\",{\"className\":\"hljs-property\",\"children\":\"path\"}],\";\\n\\n    \",[\"$\",\"span\",\"span-25\",{\"className\":\"hljs-keyword\",\"children\":\"try\"}],\" {\\n        \",[\"$\",\"span\",\"span-26\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" data = \",[\"$\",\"span\",\"span-27\",{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" fs.\",[\"$\",\"span\",\"span-28\",{\"className\":\"hljs-title function_\",\"children\":\"readFile\"}],\"(path.\",[\"$\",\"span\",\"span-29\",{\"className\":\"hljs-title function_\",\"children\":\"join\"}],\"(nextPath, \",[\"$\",\"span\",\"span-30\",{\"className\":\"hljs-string\",\"children\":\"\\\"static\\\"\"}],\", staticFilePath));\\n\\n        \",[\"$\",\"span\",\"span-31\",{\"className\":\"hljs-keyword\",\"children\":\"return\"}],\" {\\n            \",[\"$\",\"span\",\"span-32\",{\"className\":\"hljs-attr\",\"children\":\"body\"}],\": data\\n        }\\n\\n    } \",[\"$\",\"span\",\"span-33\",{\"className\":\"hljs-keyword\",\"children\":\"catch\"}],\" {\\n        \",[\"$\",\"span\",\"span-34\",{\"className\":\"hljs-keyword\",\"children\":\"return\"}],\" {\\n            \",[\"$\",\"span\",\"span-35\",{\"className\":\"hljs-attr\",\"children\":\"body\"}],\": \",[\"$\",\"span\",\"span-36\",{\"className\":\"hljs-string\",\"children\":[\"`File not found \",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-subst\",\"children\":[\"$${\",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-built_in\",\"children\":\"JSON\"}],\".stringify(req.query)}\"]}],\"`\"]}],\"\\n        }\\n    }\\n}\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-18\",{\"children\":\"This example could be more sophisticated with the inclusion of the Content-Type header. But the modern browsers seem to handle this fine.\"}],\"\\n\",[\"$\",\"h2\",\"h2-3\",{\"children\":\"Choosing the right CDN\"}],\"\\n\",[\"$\",\"p\",\"p-19\",{\"children\":\"While picking the CDN for your Azure Function it's important to pick one that supports this Response Header correctly:\"}],\"\\n\",[\"$\",\"p\",\"p-20\",{\"children\":[\"$\",\"code\",\"code-0\",{\"children\":\"cache-control: s-maxage=10,stale-while-revalidate\"}]}],\"\\n\",[\"$\",\"p\",\"p-21\",{\"children\":[\"You want the s-maxage value to be the same value as configured for \",[\"$\",\"code\",\"code-0\",{\"children\":\"revalidate\"}],\" in \",[\"$\",\"code\",\"code-1\",{\"children\":\"getStaticProps\"}]]}],\"\\n\",[\"$\",\"pre\",\"pre-4\",{\"children\":[\"$\",\"code\",\"code-0\",{\"className\":\"hljs language-javascript\",\"children\":[[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-comment\",\"children\":\"// static site generation...\"}],\"\\n\",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-keyword\",\"children\":\"export\"}],\" \",[\"$\",\"span\",\"span-2\",{\"className\":\"hljs-keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",\"span-3\",{\"className\":\"hljs-keyword\",\"children\":\"function\"}],\" \",[\"$\",\"span\",\"span-4\",{\"className\":\"hljs-title function_\",\"children\":\"getStaticProps\"}],\"(\",[\"$\",\"span\",\"span-5\",{\"className\":\"hljs-params\"}],\") {\\n    \",[\"$\",\"span\",\"span-6\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" res = \",[\"$\",\"span\",\"span-7\",{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",\"span-8\",{\"className\":\"hljs-title function_\",\"children\":\"fetch\"}],\"(\",[\"$\",\"span\",\"span-9\",{\"className\":\"hljs-string\",\"children\":\"'https://baconipsum.com/api/?type=meat-and-filler'\"}],\")\\n    \",[\"$\",\"span\",\"span-10\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" meats = \",[\"$\",\"span\",\"span-11\",{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" res.\",[\"$\",\"span\",\"span-12\",{\"className\":\"hljs-title function_\",\"children\":\"json\"}],\"()\\n    \",[\"$\",\"span\",\"span-13\",{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" now = \",[\"$\",\"span\",\"span-14\",{\"className\":\"hljs-keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",\"span-15\",{\"className\":\"hljs-title class_\",\"children\":\"Date\"}],\"();\\n\\n    \",[\"$\",\"span\",\"span-16\",{\"className\":\"hljs-keyword\",\"children\":\"return\"}],\" {\\n        \",[\"$\",\"span\",\"span-17\",{\"className\":\"hljs-attr\",\"children\":\"props\"}],\": {\\n            meats,\\n            \",[\"$\",\"span\",\"span-18\",{\"className\":\"hljs-attr\",\"children\":\"date\"}],\": \",[\"$\",\"span\",\"span-19\",{\"className\":\"hljs-string\",\"children\":[\"`\",[\"$\",\"span\",\"span-0\",{\"className\":\"hljs-subst\",\"children\":\"$${now.toLocaleDateString()}\"}],\" - \",[\"$\",\"span\",\"span-1\",{\"className\":\"hljs-subst\",\"children\":\"$${now.toLocaleTimeString()}\"}],\"`\"]}],\"\\n        },\\n        \",[\"$\",\"span\",\"span-20\",{\"className\":\"hljs-attr\",\"children\":\"revalidate\"}],\": \",[\"$\",\"span\",\"span-21\",{\"className\":\"hljs-number\",\"children\":\"10\"}],\"\\n    }\\n}\\n\"]}]}],\"\\n\",[\"$\",\"p\",\"p-22\",{\"children\":[\"Not all \",[\"$\",\"a\",\"a-0\",{\"href\":\"https://docs.microsoft.com/en-us/azure/cdn/cdn-features\",\"children\":\"CDN's\"}],\" in Azure support this. Only \",[\"$\",\"code\",\"code-0\",{\"children\":\"Standard Microsoft\"}],\" and \",[\"$\",\"code\",\"code-1\",{\"children\":\"Premium Verizon\"}],\" support this feature currently.\"]}],\"\\n\",[\"$\",\"h2\",\"h2-4\",{\"children\":\"What's next?\"}],\"\\n\",[\"$\",\"p\",\"p-23\",{\"children\":\"This is my first post about my investigation on Next.js on azure and Sitecore JSS. Coming up are posts about:\"}],\"\\n\",[\"$\",\"ul\",\"ul-2\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":\"Deploying Azure Functions using Github actions\"}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":\"Sitecore JSS on azure functions\"}],\"\\n\",[\"$\",\"li\",\"li-2\",{\"children\":\"Creating components in Sitecore JSS\"}],\"\\n\",[\"$\",\"li\",\"li-3\",{\"children\":\"Integrate Sitecore OrderCloud and other services in Sitecore JSS\"}],\"\\n\"]}]]}]]}]\n"])</script><script>self.__next_f.push([1,"f:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Next.js on Azure Functions\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Erwin Smit - Freelance frontend developer / fullstack developer\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:title\",\"content\":\"Next.js on Azure Functions\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:description\",\"content\":\"Erwin Smit - Freelance frontend developer / fullstack developer\"}],[\"$\",\"meta\",\"5\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"6\",{\"name\":\"twitter:title\",\"content\":\"Next.js on Azure Functions\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:description\",\"content\":\"Erwin Smit - Freelance frontend developer / fullstack developer\"}]]\n"])</script><script>self.__next_f.push([1,"b:null\n"])</script></body></html>